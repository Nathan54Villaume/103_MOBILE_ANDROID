<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Menu Settings - Probl√®mes Corrig√©s</title>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: system-ui; 
            padding: 20px; 
            margin: 0;
        }
        .test-area {
            width: 500px;
            height: 300px;
            background: #1e293b;
            border: 2px solid #4b5563;
            margin: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }
        .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #4f46e5;
        }
        .btn-success {
            background: #059669;
        }
        .btn-success:hover {
            background: #047857;
        }
        .btn-warning {
            background: #f59e0b;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        .btn-danger {
            background: #dc2626;
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        #info {
            background: #111827;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .test-section h3 {
            margin-top: 0;
            color: #f1f5f9;
        }
        .test-checklist {
            background: #0f172a;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .test-checklist li {
            margin: 5px 0;
            padding: 2px 0;
        }
        .test-checklist .check {
            color: #10b981;
        }
        .test-checklist .cross {
            color: #ef4444;
        }
        .test-checklist .warning {
            color: #f59e0b;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
    </style>
</head>
<body>
    <h1>üîß Test Menu Settings - Probl√®mes Corrig√©s</h1>
    <p>Test des corrections apport√©es au menu de r√©glages</p>
    
    <div class="test-grid">
        <div class="test-section">
            <h3>üìä Chart de Test</h3>
            <div class="test-area" id="testArea">
                <div style="text-align: center;">
                    <div>üìà Chart de Test</div>
                    <div style="font-size: 14px; margin-top: 10px; color: #94a3b8;">
                        Clic droit pour menu contextuel<br>
                        Ou bouton "Ouvrir Settings"
                    </div>
                </div>
            </div>
            <button onclick="testSettingsMenu()" class="btn">
                üîß Ouvrir Settings
            </button>
            <button onclick="testChartCreation()" class="btn btn-success">
                üìä Cr√©er Chart
            </button>
        </div>
        
        <div class="test-section">
            <h3>‚úÖ Checklist des Corrections</h3>
            <div class="test-checklist">
                <h4>Probl√®mes corrig√©s :</h4>
                <ul>
                    <li><span class="status-indicator status-success"></span>Bouton "Valider" fonctionne</li>
                    <li><span class="status-indicator status-success"></span>Bouton "Fermer" fonctionne</li>
                    <li><span class="status-indicator status-success"></span>Bouton "R√©initialiser" fonctionne</li>
                    <li><span class="status-indicator status-success"></span>√âpaisseur des lignes persiste</li>
                    <li><span class="status-indicator status-success"></span>Y commence √† 0 fonctionne</li>
                    <li><span class="status-indicator status-success"></span>Param√®tres refl√®tent l'√©tat actuel</li>
                </ul>
                
                <h4>Tests √† effectuer :</h4>
                <ul>
                    <li>üîß Ouvrir le menu de r√©glages</li>
                    <li>üìè Changer l'√©paisseur de ligne</li>
                    <li>üìä Cocher "Y commence √† 0"</li>
                    <li>üíæ Cliquer sur "Valider"</li>
                    <li>üîÑ Rouvrir le menu (doit garder les param√®tres)</li>
                    <li>üîÑ Cliquer sur "R√©initialiser"</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>üéõÔ∏è Tests Sp√©cifiques</h3>
        <button onclick="testSaveButton()" class="btn btn-success">Test Bouton Valider</button>
        <button onclick="testCloseButton()" class="btn btn-warning">Test Bouton Fermer</button>
        <button onclick="testResetButton()" class="btn btn-danger">Test Bouton R√©initialiser</button>
        <button onclick="testLineWidthPersistence()" class="btn btn-warning">Test Persistance √âpaisseur</button>
        <button onclick="testYZeroFunctionality()" class="btn btn-warning">Test Y Commence √† 0</button>
        <button onclick="testStateLoading()" class="btn btn-warning">Test Chargement √âtat</button>
        <button onclick="clearLog()" class="btn">üóëÔ∏è Vider Logs</button>
    </div>
    
    <div id="info"></div>
    
    <!-- Inclure les d√©pendances n√©cessaires -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <script type="module">
        // Import des modules
        import { initChart, getChart } from './charts/index.js';
        import { initChartSettings } from './js/chart-settings.js';
        
        const info = document.getElementById('info');
        let testChartInstance = null;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            div.innerHTML = `<span style="color: #6b7280;">[${timestamp}]</span> ${icon} ${message}`;
            info.appendChild(div);
            info.scrollTop = info.scrollHeight;
        }
        
        function clearLog() {
            info.innerHTML = '';
        }
        
        // Initialiser le syst√®me de settings
        initChartSettings();
        log('Syst√®me de settings initialis√©', 'success');
        
        // Cr√©er un canvas de test
        function createTestCanvas() {
            const canvas = document.createElement('canvas');
            canvas.id = 'test-chart-canvas';
            canvas.width = 480;
            canvas.height = 280;
            canvas.style.border = '1px solid #4b5563';
            canvas.style.borderRadius = '8px';
            canvas.style.background = '#0f172a';
            return canvas;
        }
        
        // Cr√©er des donn√©es de test r√©alistes
        function generateTestData() {
            const now = Date.now();
            const data1 = [];
            const data2 = [];
            
            for (let i = 0; i < 50; i++) {
                const time = now - (49 - i) * 60000; // 1 point par minute
                const value1 = 100 + Math.sin(i * 0.2) * 30 + Math.random() * 10;
                const value2 = 80 + Math.cos(i * 0.15) * 25 + Math.random() * 8;
                
                data1.push({ x: time, y: value1 });
                data2.push({ x: time, y: value2 });
            }
            
            return {
                datasets: [
                    {
                        label: 'Signal TR1 Puissance',
                        data: data1,
                        borderColor: '#6366f1',
                        backgroundColor: '#6366f120',
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: 'Signal TR2 Puissance',
                        data: data2,
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b20',
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            };
        }
        
        // Cr√©er un chart de test
        window.testChartCreation = async function() {
            try {
                log('Cr√©ation d\'un chart de test...');
                
                // Cr√©er le canvas
                const canvas = createTestCanvas();
                document.getElementById('testArea').innerHTML = '';
                document.getElementById('testArea').appendChild(canvas);
                
                // Initialiser le chart
                testChartInstance = initChart('test-chart', 'test-chart-canvas', {
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#e2e8f0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    tooltipFormat: 'HH:mm:ss'
                                },
                                ticks: {
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(148,163,184,0.15)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(148,163,184,0.15)'
                                }
                            }
                        }
                    }
                });
                
                if (testChartInstance) {
                    log('Chart de test cr√©√© avec succ√®s', 'success');
                    
                    // Ajouter des donn√©es de test
                    const testData = generateTestData();
                    testChartInstance.host.setData(testData.datasets);
                    log('Donn√©es de test ajout√©es (2 signaux, 50 points chacun)', 'success');
                    
                } else {
                    log('√âchec de cr√©ation du chart', 'error');
                }
                
            } catch (error) {
                log(`Erreur cr√©ation chart: ${error.message}`, 'error');
                console.error('Erreur d√©taill√©e:', error);
            }
        };
        
        // Tester le menu de settings
        window.testSettingsMenu = function() {
            if (!testChartInstance) {
                log('Cr√©er d\'abord un chart de test', 'warning');
                return;
            }
            
            try {
                log('Ouverture du menu de settings...');
                
                // Simuler l'√©v√©nement d'ouverture des settings
                const event = new CustomEvent('chart:open-settings', {
                    detail: { chartKey: 'test-chart' }
                });
                document.dispatchEvent(event);
                
                log('√âv√©nement chart:open-settings envoy√©', 'success');
                
            } catch (error) {
                log(`Erreur ouverture settings: ${error.message}`, 'error');
                console.error('Erreur d√©taill√©e:', error);
            }
        };
        
        // Tests sp√©cifiques
        window.testSaveButton = function() {
            log('üß™ Test du bouton Valider...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Modifier des param√®tres (ex: √©paisseur ligne, Y commence √† 0)');
            log('   3. Cliquer sur "Valider" (en bas √† droite)');
            log('   4. Le menu doit se fermer ET sauvegarder les param√®tres');
            log('   5. Rouvrir le menu - les param√®tres doivent √™tre conserv√©s');
        };
        
        window.testCloseButton = function() {
            log('üß™ Test du bouton Fermer...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Cliquer sur "Fermer" (en haut √† droite)');
            log('   3. Le menu doit se fermer sans sauvegarder');
        };
        
        window.testResetButton = function() {
            log('üß™ Test du bouton R√©initialiser...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Modifier des param√®tres');
            log('   3. Cliquer sur "R√©initialiser"');
            log('   4. Les param√®tres doivent revenir aux valeurs par d√©faut');
        };
        
        window.testLineWidthPersistence = function() {
            log('üß™ Test de persistance √©paisseur ligne...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Changer l\'√©paisseur de ligne (ex: 4px)');
            log('   3. Cliquer sur "Valider"');
            log('   4. Rouvrir le menu - l\'√©paisseur doit √™tre √† 4px');
        };
        
        window.testYZeroFunctionality = function() {
            log('üß™ Test de "Y commence √† 0"...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Cocher "Y commence √† 0"');
            log('   3. Cliquer sur "Valider"');
            log('   4. L\'axe Y doit commencer √† 0 et rester ainsi');
        };
        
        window.testStateLoading = function() {
            log('üß™ Test de chargement de l\'√©tat actuel...');
            log('   1. Cr√©er un chart avec des param√®tres sp√©cifiques');
            log('   2. Ouvrir le menu de settings');
            log('   3. Les param√®tres doivent refl√©ter l\'√©tat actuel du chart');
        };
        
        // Test du menu contextuel
        document.getElementById('testArea').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            log('Clic droit d√©tect√© - test du menu contextuel');
            
            // Simuler l'ouverture du menu contextuel
            const event = new CustomEvent('chart:contextmenu', {
                detail: { 
                    chartKey: 'test-chart',
                    x: e.clientX,
                    y: e.clientY
                }
            });
            document.dispatchEvent(event);
        });
        
        // √âcouter les √©v√©nements de settings
        document.addEventListener('chart:open-settings', function(e) {
            log(`√âv√©nement chart:open-settings re√ßu pour: ${e.detail?.chartKey}`, 'success');
        });
        
        document.addEventListener('chart:export', function(e) {
            log(`√âv√©nement chart:export re√ßu pour: ${e.detail?.chartKey}`, 'success');
        });
        
        document.addEventListener('chart:reset-view', function(e) {
            log(`√âv√©nement chart:reset-view re√ßu pour: ${e.detail?.chartKey}`, 'success');
        });
        
        log('Syst√®me de test initialis√©', 'success');
        log('Instructions:', 'info');
        log('   1. Cliquer sur "Cr√©er Chart" pour cr√©er un graphique de test', 'info');
        log('   2. Cliquer sur "Ouvrir Settings" pour tester le menu', 'info');
        log('   3. Utiliser les boutons de test sp√©cifiques', 'info');
        log('   4. V√©rifier que tous les probl√®mes sont corrig√©s', 'info');
    </script>
</body>
</html>
