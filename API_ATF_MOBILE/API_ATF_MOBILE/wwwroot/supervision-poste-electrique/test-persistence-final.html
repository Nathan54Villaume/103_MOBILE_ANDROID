<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Persistance Final</title>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: system-ui; 
            padding: 20px; 
            margin: 0;
        }
        .test-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #4f46e5;
        }
        .test-button.success {
            background: #059669;
        }
        .test-button.error {
            background: #dc2626;
        }
        .log {
            background: #111827;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .status.success {
            background: #065f46;
            color: #d1fae5;
        }
        .status.error {
            background: #7f1d1d;
            color: #fecaca;
        }
        .status.info {
            background: #1e3a8a;
            color: #dbeafe;
        }
        .chart-container {
            width: 600px;
            height: 300px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin: 20px 0;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
        }
        .test-step {
            background: #374151;
            border-left: 4px solid #6366f1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 6px 6px 0;
        }
        .test-step h4 {
            margin: 0 0 10px 0;
            color: #6366f1;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Persistance Final</h1>
    
    <div class="test-section">
        <h2>Instructions de Test</h2>
        <div class="test-step">
            <h4>√âtape 1 : Cr√©er un chart</h4>
            <p>Cliquez sur "Cr√©er Chart Test" pour cr√©er un chart avec des donn√©es de test.</p>
        </div>
        <div class="test-step">
            <h4>√âtape 2 : Modifier les param√®tres</h4>
            <p>Cliquez sur "Ouvrir Param√®tres" et modifiez des param√®tres comme :</p>
            <ul>
                <li>‚úÖ "Y commence √† 0" (coch√©)</li>
                <li>‚úÖ "Masquer grille" (d√©coch√©)</li>
                <li>‚úÖ "√âpaisseur ligne" = 4px</li>
                <li>‚úÖ "Transparence" = 30%</li>
            </ul>
        </div>
        <div class="test-step">
            <h4>√âtape 3 : Valider et fermer</h4>
            <p>Cliquez sur "Valider" pour sauvegarder les param√®tres.</p>
        </div>
        <div class="test-step">
            <h4>√âtape 4 : Simuler le polling</h4>
            <p>Cliquez sur "Simuler Polling" pour simuler une mise √† jour des donn√©es.</p>
        </div>
        <div class="test-step">
            <h4>√âtape 5 : V√©rifier la persistance</h4>
            <p>Rouvrez les param√®tres et v√©rifiez que vos modifications sont toujours l√† !</p>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Chart</h2>
        <div class="chart-container">
            <canvas id="test-chart-canvas"></canvas>
        </div>
        <button class="test-button" onclick="createTestChart()">Cr√©er Chart Test</button>
        <button class="test-button" onclick="openTestSettings()">Ouvrir Param√®tres</button>
        <button class="test-button" onclick="simulatePolling()">Simuler Polling</button>
        <button class="test-button" onclick="checkLocalStorage()">V√©rifier localStorage</button>
        <button class="test-button" onclick="clearAllData()">Vider Donn√©es</button>
        <div id="chartStatus"></div>
    </div>

    <div class="test-section">
        <h2>R√©sultats</h2>
        <div id="testResults"></div>
    </div>

    <div class="log" id="log">
        <div>üöÄ Test de persistance final initialis√©</div>
        <div>üëâ Suivez les √©tapes ci-dessus pour tester la persistance</div>
    </div>

    <script type="module">
        import { ChartHost } from './charts/core/ChartHost.js';
        import { initChart } from './charts/index.js';
        
        const log = document.getElementById('log');
        let testChart = null;
        let testData = [];
        
        function addLog(message, type = 'info') {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            div.style.color = type === 'error' ? '#f87171' : type === 'success' ? '#34d399' : '#e5e7eb';
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function setResult(message, type = 'info') {
            const element = document.getElementById('testResults');
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        window.createTestChart = function() {
            addLog('üß™ Cr√©ation chart test...');
            
            try {
                // Cr√©er des donn√©es de test
                testData = [];
                const now = Date.now();
                for (let i = 0; i < 100; i++) {
                    testData.push({
                        x: now - (100 - i) * 60000, // 1 minute entre chaque point
                        y: Math.sin(i * 0.1) * 100 + 200 + Math.random() * 50
                    });
                }
                
                // Cr√©er le chart via le syst√®me
                testChart = initChart('test-chart', 'test-chart-canvas', {
                    type: 'power',
                    tr: 1
                });
                
                if (testChart) {
                    // Ajouter des donn√©es de test
                    testChart.host.setData([{
                        label: 'Test Signal',
                        data: testData,
                        borderColor: '#6366f1',
                        backgroundColor: '#6366f120',
                        borderWidth: 2,
                        tension: 0.1
                    }]);
                    
                    addLog('‚úÖ Chart test cr√©√© avec succ√®s');
                    setStatus('chartStatus', '‚úÖ Chart test cr√©√©', 'success');
                } else {
                    addLog('‚ùå √âchec cr√©ation chart test', 'error');
                    setStatus('chartStatus', '‚ùå √âchec cr√©ation chart', 'error');
                }
                
            } catch (error) {
                addLog('‚ùå Erreur cr√©ation chart: ' + error.message, 'error');
                setStatus('chartStatus', '‚ùå Erreur cr√©ation chart: ' + error.message, 'error');
            }
        };

        window.openTestSettings = function() {
            addLog('üß™ Ouverture param√®tres test...');
            
            if (!testChart) {
                addLog('‚ùå Chart test non cr√©√©', 'error');
                return;
            }
            
            try {
                // Simuler l'√©v√©nement d'ouverture des param√®tres
                document.dispatchEvent(new CustomEvent('chart:open-settings', {
                    detail: { chartKey: 'test-chart' }
                }));
                
                addLog('‚úÖ √âv√©nement d\'ouverture envoy√©');
                addLog('‚ÑπÔ∏è Modifiez des param√®tres et cliquez sur "Valider"');
                
            } catch (error) {
                addLog('‚ùå Erreur ouverture param√®tres: ' + error.message, 'error');
            }
        };

        window.simulatePolling = function() {
            addLog('üß™ Simulation du polling...');
            
            if (!testChart) {
                addLog('‚ùå Chart test non cr√©√©', 'error');
                return;
            }
            
            try {
                // G√©n√©rer de nouvelles donn√©es
                const newData = [];
                const now = Date.now();
                for (let i = 0; i < 100; i++) {
                    newData.push({
                        x: now - (100 - i) * 60000,
                        y: Math.sin(i * 0.15) * 120 + 180 + Math.random() * 60
                    });
                }
                
                // Mettre √† jour les donn√©es (comme le ferait le polling)
                testChart.host.setData([{
                    label: 'Test Signal (Updated)',
                    data: newData,
                    borderColor: '#6366f1',
                    backgroundColor: '#6366f120',
                    borderWidth: 2,
                    tension: 0.1
                }]);
                
                addLog('‚úÖ Donn√©es mises √† jour (simulation polling)');
                addLog('‚ÑπÔ∏è V√©rifiez que les param√®tres sont toujours appliqu√©s');
                
                // V√©rifier les param√®tres sauvegard√©s
                const settings = testChart.host.currentSettings;
                if (settings) {
                    addLog(`üìã Param√®tres sauvegard√©s: Y=0:${settings.yZero}, Grille:${settings.showGrid}, Ligne:${settings.lineWidth}px`);
                    setResult(`‚úÖ Param√®tres pr√©serv√©s apr√®s polling: Y=0:${settings.yZero}, Grille:${settings.showGrid}, Ligne:${settings.lineWidth}px`, 'success');
                } else {
                    addLog('‚ö†Ô∏è Aucun param√®tre sauvegard√© trouv√©', 'error');
                    setResult('‚ùå Aucun param√®tre sauvegard√© trouv√©', 'error');
                }
                
            } catch (error) {
                addLog('‚ùå Erreur simulation polling: ' + error.message, 'error');
            }
        };

        window.checkLocalStorage = function() {
            addLog('üß™ V√©rification localStorage...');
            
            const keys = Object.keys(localStorage);
            const chartKeys = keys.filter(key => key.includes('chart-'));
            
            if (chartKeys.length === 0) {
                addLog('‚ÑπÔ∏è Aucun param√®tre de chart dans localStorage');
                setResult('‚ÑπÔ∏è Aucun param√®tre trouv√© dans localStorage', 'info');
                return;
            }
            
            chartKeys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    addLog(`üìã ${key}: ${value}`);
                } catch (error) {
                    addLog(`‚ùå Erreur lecture ${key}: ${error.message}`, 'error');
                }
            });
            
            setResult(`‚úÖ ${chartKeys.length} param√®tre(s) trouv√©(s) dans localStorage`, 'success');
        };

        window.clearAllData = function() {
            addLog('üßπ Nettoyage de toutes les donn√©es...');
            
            // Vider localStorage
            const keys = Object.keys(localStorage);
            const chartKeys = keys.filter(key => key.includes('chart-'));
            chartKeys.forEach(key => {
                localStorage.removeItem(key);
                addLog(`üóëÔ∏è Supprim√©: ${key}`);
            });
            
            // R√©initialiser le chart
            if (testChart) {
                testChart.host.currentSettings = null;
                addLog('üóëÔ∏è Param√®tres du chart r√©initialis√©s');
            }
            
            addLog(`‚úÖ ${chartKeys.length} param√®tre(s) supprim√©(s)`);
            setResult(`‚úÖ ${chartKeys.length} param√®tre(s) supprim√©(s)`, 'success');
        };

        // Initialisation
        addLog('üöÄ Test de persistance final initialis√©');
        addLog('üëâ Suivez les √©tapes pour tester la persistance des param√®tres');
        addLog('‚ÑπÔ∏è Le test v√©rifie que les param√®tres persistent apr√®s le polling');
    </script>
</body>
</html>
