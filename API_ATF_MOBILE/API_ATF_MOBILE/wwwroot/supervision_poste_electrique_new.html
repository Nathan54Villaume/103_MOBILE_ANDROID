<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supervision — Poste Électrique</title>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Icons -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a; --card:#121a2e; --muted:#8ea5c0; --text:#e6eef9; --accent:#7c9cff;
    --good:#19c37d; --warn:#ffcc00; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  header{padding:18px 22px;border-bottom:1px solid #1f2d4a;background:#0e1526;position:sticky;top:0;z-index:10}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  h1{font-size:22px;margin:0;font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1222;border:1px solid #1f2d4a;color:var(--muted)}
  main{padding:18px}
  .tabs{display:flex;gap:8px;margin-top:8px}
  .tab{padding:8px 12px;border:1px solid #1f2d4a;background:#0b1222;border-radius:10px;cursor:pointer;color:var(--muted)}
  .tab.active{background:#12203b;color:#fff;border-color:#27416d}
  .grid{display:grid;gap:16px}
  @media(min-width:1100px){ .grid-2{grid-template-columns:1fr 1fr} }
  .card{background:var(--card);border:1px solid #1f2d4a;border-radius:14px;padding:14px}
  .kpis{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
  .kpi{background:#0b1222;border:1px solid #1f2d4a;border-radius:12px;padding:12px;min-height:76px}
  .kpi h4{margin:0 0 6px;font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.4px}
  .kpi .v{font-size:22px;font-weight:800}
  .group-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .legend{display:flex;gap:10px;align-items:center}
  .legend span{font-size:12px;color:var(--muted)}
  .switches{display:flex;gap:10px;flex-wrap:wrap}
  .sw{display:flex;align-items:center;gap:6px;background:#0b1222;border:1px solid #1f2d4a;padding:6px 8px;border-radius:10px;font-size:12px;color:#c7d5ea;cursor:pointer}
  .sw input{accent-color:#5ea0ff}
  .toolbar{display:flex;gap:8px;align-items:center}
  select,input{background:#0b1222;border:1px solid #1f2d4a;color:#cfe4ff;border-radius:8px;padding:6px 8px}
  button{background:#193158;border:1px solid #27416d;color:#eaf2ff;border-radius:10px;padding:8px 10px;cursor:pointer}
  button.ghost{background:#0b1222;border-color:#1f2d4a;color:#cfe4ff}
  .foot{color:#7f96b3;font-size:12px;margin-top:8px}
  .ok{color:var(--good)} .bad{color:var(--bad)}
  canvas{width:100%;height:360px}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>Supervision — Poste Électrique</h1>
    <span id="conn" class="pill">Hors ligne</span>
    <div style="margin-left:auto" class="row">
      <button id="btnSettings" class="ghost">Paramètres</button>
      <div class="tabs">
        <div id="tabLive" class="tab active">Supervision</div>
        <div id="tabDaily" class="tab">Journalier (24 h)</div>
      </div>
    </div>
  </div>
</header>

<main>
  <!-- ======================= LIVE ======================= -->
  <section id="pageLive">
    <div class="card">
      <div class="group-head">
        <strong>Paramètres d’acquisition</strong>
        <div class="toolbar">
          <label>Base de temps
            <select id="winSelect">
              <option value="15">15 min</option>
              <option value="30">30 min</option>
              <option value="60">1 h</option>
              <option value="240">4 h</option>
            </select>
          </label>
          <button id="btnReload" class="ghost">Recharger historique</button>
        </div>
      </div>
      <div class="kpis">
        <div class="kpi"><h4>Puissance (kW) — TR1</h4><div id="k_tr1_p" class="v">—</div></div>
        <div class="kpi"><h4>Réactive (kvar) — TR1</h4><div id="k_tr1_q" class="v">—</div></div>
        <div class="kpi"><h4>PF — TR1</h4><div id="k_tr1_pf" class="v">—</div></div>
        <div class="kpi"><h4>U12/U23/U31 (V) — TR1</h4><div id="k_tr1_u" class="v">—</div></div>
        <div class="kpi"><h4>I1/I2/I3 (A) — TR1</h4><div id="k_tr1_i" class="v">—</div></div>
        <div class="kpi"><h4>Énergie (kWh) — TR1</h4><div id="k_tr1_e" class="v">—</div></div>

        <div class="kpi"><h4>Puissance (kW) — TR2</h4><div id="k_tr2_p" class="v">—</div></div>
        <div class="kpi"><h4>Réactive (kvar) — TR2</h4><div id="k_tr2_q" class="v">—</div></div>
        <div class="kpi"><h4>PF — TR2</h4><div id="k_tr2_pf" class="v">—</div></div>
        <div class="kpi"><h4>U12/U23/U31 (V) — TR2</h4><div id="k_tr2_u" class="v">—</div></div>
        <div class="kpi"><h4>I1/I2/I3 (A) — TR2</h4><div id="k_tr2_i" class="v">—</div></div>
        <div class="kpi"><h4>Énergie (kWh) — TR2</h4><div id="k_tr2_e" class="v">—</div></div>
      </div>
    </div>

    <div class="grid grid-2" style="margin-top:16px">
      <!-- TR1 -->
      <div class="card">
        <div class="group-head">
          <strong>Puissance — TR1</strong>
          <div class="switches">
            <label class="sw"><input id="t1_show_q" type="checkbox" checked> Afficher Q (kvar)</label>
            <label class="sw"><input id="t1_show_pf" type="checkbox" checked> Afficher PF</label>
          </div>
        </div>
        <canvas id="c_tr1_p"></canvas>
        <div id="stats_tr1" class="foot"></div>
      </div>
      <div class="card">
        <div class="group-head"><strong>Tensions de phase — TR1</strong><span class="legend"><span>U12/U23/U31</span></span></div>
        <canvas id="c_tr1_u"></canvas>
      </div>

      <!-- TR2 -->
      <div class="card">
        <div class="group-head">
          <strong>Puissance — TR2</strong>
          <div class="switches">
            <label class="sw"><input id="t2_show_q" type="checkbox" checked> Afficher Q (kvar)</label>
            <label class="sw"><input id="t2_show_pf" type="checkbox" checked> Afficher PF</label>
          </div>
        </div>
        <canvas id="c_tr2_p"></canvas>
        <div id="stats_tr2" class="foot"></div>
      </div>
      <div class="card">
        <div class="group-head"><strong>Tensions de phase — TR2</strong><span class="legend"><span>U12/U23/U31</span></span></div>
        <canvas id="c_tr2_u"></canvas>
      </div>
    </div>

    <div id="upd" class="foot" style="margin-top:10px">Dernière mise à jour : —</div>
  </section>

  <!-- ======================= DAILY ======================= -->
  <section id="pageDaily" class="hidden">
    <div class="card">
      <div class="group-head">
        <strong>Indicateurs journaliers (24 h roulantes)</strong>
        <div class="toolbar">
          <button id="btnDailyRefresh" class="ghost">Rafraîchir</button>
        </div>
      </div>
      <div class="grid grid-2">
        <div class="card">
          <h3 style="margin:0 0 8px">Transformateur 1</h3>
          <div class="kpis" style="grid-template-columns:repeat(3,minmax(0,1fr))">
            <div class="kpi"><h4>kWh / 24 h</h4><div id="d_tr1_kwh" class="v">—</div></div>
            <div class="kpi"><h4>kW max</h4><div id="d_tr1_pmax" class="v">—</div></div>
            <div class="kpi"><h4>cos φ min</h4><div id="d_tr1_pfmin" class="v">—</div></div>
          </div>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px">Transformateur 2</h3>
          <div class="kpis" style="grid-template-columns:repeat(3,minmax(0,1fr))">
            <div class="kpi"><h4>kWh / 24 h</h4><div id="d_tr2_kwh" class="v">—</div></div>
            <div class="kpi"><h4>kW max</h4><div id="d_tr2_pmax" class="v">—</div></div>
            <div class="kpi"><h4>cos φ min</h4><div id="d_tr2_pfmin" class="v">—</div></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- ======================= SETTINGS MODAL ======================= -->
<dialog id="dlg" style="border:none;border-radius:14px;padding:0;max-width:620px;width:96%;background:#0e1526;color:#eaf2ff">
  <div class="card" style="border:none">
    <h3 style="margin:0 0 8px">Paramètres</h3>
    <div class="grid">
      <label>API Base URL
        <input id="apiBase" placeholder="http://host:port/api/energy" />
      </label>
      <label>Intervalle de rafraîchissement (ms)
        <input id="pollMs" type="number" min="500" step="100" value="1000" />
      </label>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="dlgClose" class="ghost">Fermer</button>
      <button id="dlgSave">Enregistrer</button>
    </div>
  </div>
</dialog>

<script>
/* ====================== STATE ====================== */
const state = {
  apiBase: localStorage.getItem('apiBase') || '',
  pollMs:  Number(localStorage.getItem('pollMs') || 1000),
  connected: false,
  initialLoad: true,
};
const bufs = {
  // séries TR1
  p1:[], q1:[], pf1:[], u1_12:[], u1_23:[], u1_31:[], e1:[],
  // séries TR2
  p2:[], q2:[], pf2:[], u2_12:[], u2_23:[], u2_31:[], e2:[],
};
let pollTimer=null;

/* ====================== HELPERS ====================== */
const $ = (q)=>document.querySelector(q);
function setConn(ok,msg){
  state.connected=ok;
  $('#conn').textContent= ok?'Connecté':'Hors ligne';
  $('#conn').style.background = ok ? '#0c2a1e' : '#2a0c0c';
  $('#conn').style.color = ok ? '#8ef1c0' : '#ffb0b0';
  if(msg) console.warn(msg);
}
async function fetchJSON(url, timeout=12000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeout);
  const res = await fetch(url,{signal:ctrl.signal});
  clearTimeout(t);
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}
function fmt(n,dec=0){ if(n==null||isNaN(n)) return '—'; return Number(n).toLocaleString('fr-FR',{maximumFractionDigits:dec,minimumFractionDigits:dec}); }
function last(arr){ return arr.length ? arr[arr.length-1] : null; }
function lowerKeys(obj){ const m={}; for(const k in obj)m[k.toLowerCase()]=obj[k]; return m; }

/* ====================== NORMALISATION ====================== */
function normalizeSnapshot(d){
  const m=lowerKeys(d);
  return {
    ts:   m.ts ?? m.ts_utc ?? null,
    p_kw: m.p_kw ?? null,
    q_kvar: m.q_kvar ?? null,
    pf:   m.pf ?? null,
    u12_v: m.u12_v ?? m.u1_v ?? null,
    u23_v: m.u23_v ?? m.u2_v ?? null,
    u31_v: m.u31_v ?? m.u3_v ?? null,
    i1_a: m.i1_a ?? null, i2_a: m.i2_a ?? null, i3_a: m.i3_a ?? null,
    e_kwh: m.e_kwh ?? null
  };
}
function normPoint(p){ const x=p.x??p.X; const y=p.y??p.Y; return x?{x:new Date(x).getTime(), y:Number(y)}:null; }
function normalizeSeriesDto(dto){
  const m=lowerKeys(dto);
  const pick=(k)=> (m[k]||[]).map(normPoint).filter(Boolean);
  return {
    p_kw: pick('p_kw'),
    q_kvar: pick('q_kvar'),
    pf: pick('pf'),
    u12_v: pick('u12_v'),
    u23_v: pick('u23_v'),
    u31_v: pick('u31_v'),
    e_kwh: pick('e_kwh'),
  };
}

/* ====================== CHARTS ====================== */
Chart.defaults.color = '#cfe4ff';
Chart.defaults.borderColor = '#1f2d4a';

function makeLine(ctx,label,data,options={}){
  return new Chart(ctx,{
    type:'line',
    data:{ datasets:[
      {label, data, parsing:false, pointRadius:0, borderWidth:2, tension:0}
    ]},
    options:{
      animation:false,
      normalized:true,
      maintainAspectRatio:false,
      scales: options.scales || {
        x:{type:'time', time:{unit:'minute'}, grid:{display:false}},
        y:{beginAtZero:false}
      },
      plugins:{legend:{display:true}}
    }
  });
}

const c_tr1_p = makeLine($('#c_tr1_p'), 'P TR1 (kW)', [], {
  scales:{
    x:{type:'time', time:{unit:'minute'}, grid:{display:false}},
    y:{title:{display:true,text:'kW'}},
    y2:{position:'right', title:{display:true,text:'kvar / PF'}, min:0, max:1, grid:{display:false}}
  }
});
const c_tr1_u = new Chart($('#c_tr1_u'),{
  type:'line',
  data:{datasets:[
    {label:'U12', data:[], parsing:false, pointRadius:0, borderWidth:2, tension:0},
    {label:'U23', data:[], parsing:false, pointRadius:0, borderWidth:2, tension:0},
    {label:'U31', data:[], parsing:false, pointRadius:0, borderWidth:2, tension:0}
  ]},
  options:{animation:false,normalized:true,maintainAspectRatio:false,
    scales:{x:{type:'time', time:{unit:'minute'}, grid:{display:false}},y:{}}
  }
});

const c_tr2_p = makeLine($('#c_tr2_p'), 'P TR2 (kW)', [], {
  scales:{
    x:{type:'time', time:{unit:'minute'}, grid:{display:false}},
    y:{title:{display:true,text:'kW'}},
    y2:{position:'right', title:{display:true,text:'kvar / PF'}, min:0, max:1, grid:{display:false}}
  }
});
const c_tr2_u = new Chart($('#c_tr2_u'),{
  type:'line',
  data:{datasets:[
    {label:'U12', data:[], parsing:false, pointRadius:0, borderWidth:2, tension:0},
    {label:'U23', data:[], parsing:false, pointRadius:0, borderWidth:2, tension:0},
    {label:'U31', data:[], parsing:false, pointRadius:0, borderWidth:2, tension:0}
  ]},
  options:{animation:false,normalized:true,maintainAspectRatio:false,
    scales:{x:{type:'time', time:{unit:'minute'}, grid:{display:false}},y:{}}
  }
});

// Ajouter Q et PF datasets aux graphes P
function ensureQPFDatasets(chart){
  const labQ='Q (kvar)'; const labPF='PF';
  const hasQ = chart.data.datasets.find(d=>d.label===labQ);
  const hasPF= chart.data.datasets.find(d=>d.label===labPF);
  if(!hasQ) chart.data.datasets.push({label:labQ, data:[], parsing:false, yAxisID:'y2', borderWidth:2, pointRadius:0, borderDash:[6,4], tension:0});
  if(!hasPF) chart.data.datasets.push({label:labPF, data:[], parsing:false, yAxisID:'y2', borderWidth:2, pointRadius:0, borderDash:[2,2], tension:0});
}
ensureQPFDatasets(c_tr1_p);
ensureQPFDatasets(c_tr2_p);

// toggles
$('#t1_show_q').addEventListener('change',()=>{toggleDataset(c_tr1_p,'Q (kvar)', $('#t1_show_q').checked)});
$('#t1_show_pf').addEventListener('change',()=>{toggleDataset(c_tr1_p,'PF', $('#t1_show_pf').checked)});
$('#t2_show_q').addEventListener('change',()=>{toggleDataset(c_tr2_p,'Q (kvar)', $('#t2_show_q').checked)});
$('#t2_show_pf').addEventListener('change',()=>{toggleDataset(c_tr2_p,'PF', $('#t2_show_pf').checked)});
function toggleDataset(chart,label,on){
  const d = chart.data.datasets.find(x=>x.label===label);
  if(!d) return;
  d.hidden = !on;
  chart.update('none');
}

/* ====================== DATA LOADING ====================== */
async function pollOnce(){
  try{
    const [s1,s2] = await Promise.all([
      fetchJSON(`${state.apiBase}/tr1/snapshot`),
      fetchJSON(`${state.apiBase}/tr2/snapshot`)
    ]);
    const n1=normalizeSnapshot(s1), n2=normalizeSnapshot(s2);

    // KPIs
    $('#k_tr1_p').textContent = fmt(n1.p_kw,1);
    $('#k_tr1_q').textContent = fmt(n1.q_kvar,0);
    $('#k_tr1_pf').textContent = fmt(n1.pf,2);
    $('#k_tr1_u').textContent = fmt(Math.round(((n1.u12_v??0)+(n1.u23_v??0)+(n1.u31_v??0))/3));
    $('#k_tr1_i').textContent = fmt(Math.round(((n1.i1_a??0)+(n1.i2_a??0)+(n1.i3_a??0))/3));
    $('#k_tr1_e').textContent = fmt(n1.e_kwh,0);

    $('#k_tr2_p').textContent = fmt(n2.p_kw,1);
    $('#k_tr2_q').textContent = fmt(n2.q_kvar,0);
    $('#k_tr2_pf').textContent = fmt(n2.pf,2);
    $('#k_tr2_u').textContent = fmt(Math.round(((n2.u12_v??0)+(n2.u23_v??0)+(n2.u31_v??0))/3));
    $('#k_tr2_i').textContent = fmt(Math.round(((n2.i1_a??0)+(n2.i2_a??0)+(n2.i3_a??0))/3));
    $('#k_tr2_e').textContent = fmt(n2.e_kwh,0);

    // Push dernier point dans séries (ajout temps réel)
    const t = Date.now();
    if(n1.p_kw!=null) bufs.p1.push({x:t,y:Number(n1.p_kw)});
    if(n1.q_kvar!=null) bufs.q1.push({x:t,y:Number(n1.q_kvar)});
    if(n1.pf!=null) bufs.pf1.push({x:t,y:Number(n1.pf)});
    if(n1.u12_v!=null) bufs.u1_12.push({x:t,y:Number(n1.u12_v)});
    if(n1.u23_v!=null) bufs.u1_23.push({x:t,y:Number(n1.u23_v)});
    if(n1.u31_v!=null) bufs.u1_31.push({x:t,y:Number(n1.u31_v)});
    if(n1.e_kwh!=null) bufs.e1.push({x:t,y:Number(n1.e_kwh)});

    if(n2.p_kw!=null) bufs.p2.push({x:t,y:Number(n2.p_kw)});
    if(n2.q_kvar!=null) bufs.q2.push({x:t,y:Number(n2.q_kvar)});
    if(n2.pf!=null) bufs.pf2.push({x:t,y:Number(n2.pf)});
    if(n2.u12_v!=null) bufs.u2_12.push({x:t,y:Number(n2.u12_v)});
    if(n2.u23_v!=null) bufs.u2_23.push({x:t,y:Number(n2.u23_v)});
    if(n2.u31_v!=null) bufs.u2_31.push({x:t,y:Number(n2.u31_v)});
    if(n2.e_kwh!=null) bufs.e2.push({x:t,y:Number(n2.e_kwh)});

    refreshCharts();
    setConn(true);
    $('#upd').textContent = 'Dernière mise à jour : ' + new Date().toLocaleString('fr-FR');
  }catch(e){
    setConn(false,e.message);
  }
}

function refreshCharts(){
  // TR1 power chart datasets: P + Q + PF
  c_tr1_p.data.datasets[0].data = bufs.p1;
  const dQ1 = c_tr1_p.data.datasets.find(d=>d.label==='Q (kvar)');
  const dPF1= c_tr1_p.data.datasets.find(d=>d.label==='PF');
  if(dQ1)  dQ1.data  = bufs.q1;
  if(dPF1) dPF1.data = bufs.pf1;
  c_tr1_p.update('none');

  // TR1 tensions
  c_tr1_u.data.datasets[0].data = bufs.u1_12;
  c_tr1_u.data.datasets[1].data = bufs.u1_23;
  c_tr1_u.data.datasets[2].data = bufs.u1_31;
  c_tr1_u.update('none');

  // TR2 power
  c_tr2_p.data.datasets[0].data = bufs.p2;
  const dQ2 = c_tr2_p.data.datasets.find(d=>d.label==='Q (kvar)');
  const dPF2= c_tr2_p.data.datasets.find(d=>d.label==='PF');
  if(dQ2)  dQ2.data  = bufs.q2;
  if(dPF2) dPF2.data = bufs.pf2;
  c_tr2_p.update('none');

  // TR2 tensions
  c_tr2_u.data.datasets[0].data = bufs.u2_12;
  c_tr2_u.data.datasets[1].data = bufs.u2_23;
  c_tr2_u.data.datasets[2].data = bufs.u2_31;
  c_tr2_u.update('none');

  // Indicateurs de fenêtre
  writeStats('tr1', bufs.p1, bufs.e1);
  writeStats('tr2', bufs.p2, bufs.e2);
}

function writeStats(tag, seriesP, seriesE){
  // moyenne, min, max sur P ; ΔkWh sur E
  const sP = seriesP.map(p=>p.y);
  const avg = sP.length? (sP.reduce((a,b)=>a+b,0)/sP.length): null;
  const min = sP.length? Math.min(...sP): null;
  const max = sP.length? Math.max(...sP): null;

  let delta=null;
  if(seriesE.length>=2){
    const first = seriesE[0].y;
    const lastv = seriesE[seriesE.length-1].y;
    delta = lastv-first;
    if(delta<0) delta=null; // compteur remis à zéro
  }
  const el = $(`#stats_${tag}`);
  el.textContent = `P — moy: ${fmt(avg,1)} kW · min: ${fmt(min,1)} kW · max: ${fmt(max,1)} kW   |   ΔÉnergie: ${fmt(delta,1)} kWh`;
}

/* -------- Historique /series au chargement -------- */
async function loadSeries(trId) {
  const winMin = Number($('#winSelect').value || 15);

  const url = new URL(`${state.apiBase}/tr${trId}/series`);
  url.searchParams.set('minutes', String(winMin));
  if (winMin <= 30) {
    url.searchParams.set('agg', 'second');
    url.searchParams.set('maxPoints', '10000');
  } else {
    url.searchParams.set('agg', 'minute');
    url.searchParams.set('maxPoints', '6000');
  }
  url.searchParams.set('downsample', 'false');

  const raw = await fetchJSON(url.toString());
  const s = normalizeSeriesDto(raw);

  if (trId === 1) {
    bufs.p1=s.p_kw; bufs.q1=s.q_kvar; bufs.pf1=s.pf;
    bufs.u1_12=s.u12_v; bufs.u1_23=s.u23_v; bufs.u1_31=s.u31_v; bufs.e1=s.e_kwh;
  } else {
    bufs.p2=s.p_kw; bufs.q2=s.q_kvar; bufs.pf2=s.pf;
    bufs.u2_12=s.u12_v; bufs.u2_23=s.u23_v; bufs.u2_31=s.u31_v; bufs.e2=s.e_kwh;
  }
}

/* -------- Démarrage / polling -------- */
async function startPolling(){
  if(!state.apiBase){ setConn(false,'API non configurée'); return; }
  setConn(true);
  clearInterval(pollTimer);

  // Historique initial
  await Promise.all([loadSeries(1), loadSeries(2)]);
  refreshCharts();

  // Snapshots périodiques
  pollTimer = setInterval(pollOnce, state.pollMs);
  pollOnce();
}

/* ====================== DAILY PAGE ====================== */
async function refreshDaily(){
  try{
    const url1 = new URL(`${state.apiBase}/tr1/series`);
    url1.searchParams.set('minutes','1440'); url1.searchParams.set('agg','minute'); url1.searchParams.set('maxPoints','2000'); url1.searchParams.set('downsample','false');
    const url2 = new URL(`${state.apiBase}/tr2/series`);
    url2.searchParams.set('minutes','1440'); url2.searchParams.set('agg','minute'); url2.searchParams.set('maxPoints','2000'); url2.searchParams.set('downsample','false');

    const [r1,r2] = await Promise.all([fetchJSON(url1.toString()), fetchJSON(url2.toString())]);
    const s1 = normalizeSeriesDto(r1); const s2 = normalizeSeriesDto(r2);

    // kWh/jour = dernier E - premier E
    const d1 = (s1.e_kwh.length>=2) ? (last(s1.e_kwh).y - s1.e_kwh[0].y) : null;
    const d2 = (s2.e_kwh.length>=2) ? (last(s2.e_kwh).y - s2.e_kwh[0].y) : null;

    // kW max
    const pmax1 = s1.p_kw.length? Math.max(...s1.p_kw.map(p=>p.y)) : null;
    const pmax2 = s2.p_kw.length? Math.max(...s2.p_kw.map(p=>p.y)) : null;

    // cos φ min (si série PF sinon on calcule P / √(P²+Q²))
    const pf1 = s1.pf.length? Math.min(...s1.pf.map(p=>p.y)) :
                (s1.p_kw.length && s1.q_kvar.length ? Math.min(...s1.p_kw.map((p,i)=>{const P=p.y; const Q=(s1.q_kvar[i]?.y ?? 0); const s=Math.sqrt(P*P+Q*Q)||1; return P/s; })) : null);
    const pf2 = s2.pf.length? Math.min(...s2.pf.map(p=>p.y)) :
                (s2.p_kw.length && s2.q_kvar.length ? Math.min(...s2.p_kw.map((p,i)=>{const P=p.y; const Q=(s2.q_kvar[i]?.y ?? 0); const s=Math.sqrt(P*P+Q*Q)||1; return P/s; })) : null);

    $('#d_tr1_kwh').textContent = fmt(d1,1);
    $('#d_tr1_pmax').textContent = fmt(pmax1,1);
    $('#d_tr1_pfmin').textContent = fmt(pf1,2);

    $('#d_tr2_kwh').textContent = fmt(d2,1);
    $('#d_tr2_pmax').textContent = fmt(pmax2,1);
    $('#d_tr2_pfmin').textContent = fmt(pf2,2);

    setConn(true);
  }catch(e){
    setConn(false,e.message);
  }
}

/* ====================== UI BINDINGS ====================== */
$('#btnSettings').onclick = ()=>{ $('#apiBase').value=state.apiBase; $('#pollMs').value=state.pollMs; $('#dlg').showModal(); };
$('#dlgClose').onclick = ()=>$('#dlg').close();
$('#dlgSave').onclick = ()=>{
  state.apiBase = $('#apiBase').value.trim();
  state.pollMs  = Math.max(500, Number($('#pollMs').value||1000));
  localStorage.setItem('apiBase', state.apiBase);
  localStorage.setItem('pollMs', String(state.pollMs));
  $('#dlg').close();
  startPolling();
};
$('#btnReload').onclick = async ()=>{ await Promise.all([loadSeries(1), loadSeries(2)]); refreshCharts(); };
$('#winSelect').onchange = ()=>{ localStorage.setItem('win_live', $('#winSelect').value); $('#btnReload').click(); };

$('#tabLive').onclick = ()=>{
  $('#tabLive').classList.add('active'); $('#tabDaily').classList.remove('active');
  $('#pageLive').classList.remove('hidden'); $('#pageDaily').classList.add('hidden');
};
$('#tabDaily').onclick = ()=>{
  $('#tabDaily').classList.add('active'); $('#tabLive').classList.remove('active');
  $('#pageDaily').classList.remove('hidden'); $('#pageLive').classList.add('hidden');
  refreshDaily();
};
$('#btnDailyRefresh').onclick = ()=>refreshDaily();

/* ====================== BOOT ====================== */
window.addEventListener('load', ()=>{
  const defWin = localStorage.getItem('win_live') || '15';
  $('#winSelect').value = defWin;
  if(!state.apiBase){ $('#dlg').showModal(); }
  startPolling();
});
</script>
</body>
</html>
