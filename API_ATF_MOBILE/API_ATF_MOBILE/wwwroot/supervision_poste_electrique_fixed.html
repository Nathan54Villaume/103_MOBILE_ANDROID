<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supervision — Poste Électrique</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    html, body { height: 100%; }
    canvas { width: 100% !important; height: 320px !important; }
    .kpi { background:#1f2937; padding:1rem; border-radius:0.75rem; text-align:center; }
    .kpi h3 { font-size:0.85rem; color:#9ca3af; margin-bottom:0.25rem; }
    .kpi .group { display:flex; justify-content:space-around; margin-top:0.25rem; }
    .kpi .sub { display:flex; flex-direction:column; align-items:center; }
    .kpi .label { font-size:0.75rem; color:#9ca3af; }
    .kpi .value { font-size:1.1rem; font-weight:bold; }
    .grid-auto { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:1rem; }
    .led{ width:10px; height:10px; border-radius:9999px; box-shadow:0 0 10px currentColor; display:inline-block }
    .card { background:#1f2937; border-radius:0.75rem; padding:1rem; }
    .card-head { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .sel { background:#111827; color:#e5e7eb; border:1px solid rgba(255,255,255,.12); border-radius:.5rem; padding:.25rem .5rem; }
    .sel:focus { outline: none; box-shadow: 0 0 0 2px rgba(99,102,241,.5); border-color: rgba(99,102,241,.8); }
    #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      border: 4px solid #374151; border-top-color: #4f46e5; border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; display: none; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-900 text-white">

  <div id="loader"></div>

  <div class="max-w-7xl mx-auto p-6 space-y-10">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Supervision — Poste Électrique</h1>
        <p class="text-sm text-white/60">2 Transformateurs — Supervision détaillée</p>
      </div>
      <div class="flex items-center gap-3">
        <span id="conn-led" class="led" style="color:#ef4444" title="État connexion"></span>
        <span id="conn-text" class="text-white/70 text-sm">Déconnecté</span>
        <button id="btn-settings" class="rounded-xl bg-white/10 hover:bg-white/20 px-3 py-2 text-sm">Paramètres</button>
      </div>
    </header>

    <dialog id="settings" class="backdrop:bg-black/60 rounded-2xl w-full max-w-xl text-white">
      <form method="dialog" class="rounded-2xl bg-gray-800 border border-white/10 p-5 space-y-4">
        <h2 class="text-xl font-semibold">Paramètres</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm text-white/70">API Base URL</span>
            <input id="api-base" type="text" class="w-full mt-1 rounded-xl bg-gray-900 border border-white/10 px-3 py-2 outline-none focus:border-indigo-500" placeholder="http://10.250.13.4:8088/api/energy" />
          </label>
          <label class="block">
            <span class="text-sm text-white/70">Intervalle de rafraîchissement (ms)</span>
            <input id="poll-ms" type="number" min="500" step="100" value="2000" class="w-full mt-1 rounded-xl bg-gray-900 border border-white/10 px-3 py-2 outline-none focus:border-indigo-500" />
          </label>
        </div>
        <div class="flex items-center justify-end gap-2 pt-2">
          <button class="rounded-xl bg-white/10 hover:bg-white/20 px-3 py-2">Fermer</button>
          <button id="save-settings" type="button" class="rounded-xl bg-indigo-600 hover:bg-indigo-700 px-4 py-2">Enregistrer</button>
        </div>
      </form>
    </dialog>

    <!-- TR1 -->
    <section class="space-y-6">
      <h2 class="text-xl font-semibold">Transformateur 1</h2>
      <div class="grid-auto">
        <div class="kpi"><h3>Puissance (kW)</h3><div id="t1-p" class="value">—</div></div>
        <div class="kpi"><h3>Réactive (kvar)</h3><div id="t1-q" class="value">—</div></div>
        <div class="kpi"><h3>Facteur de Puissance</h3><div id="t1-pf" class="value">—</div></div>
        <div class="kpi">
          <h3>Tensions (V)</h3>
          <div class="group">
            <div class="sub"><span class="label">U12</span><span id="t1-u12" class="value">—</span></div>
            <div class="sub"><span class="label">U23</span><span id="t1-u23" class="value">—</span></div>
            <div class="sub"><span class="label">U31</span><span id="t1-u31" class="value">—</span></div>
          </div>
        </div>
        <div class="kpi">
          <h3>Courants (A)</h3>
          <div class="group">
            <div class="sub"><span class="label">I1</span><span id="t1-i1" class="value">—</span></div>
            <div class="sub"><span class="label">I2</span><span id="t1-i2" class="value">—</span></div>
            <div class="sub"><span class="label">I3</span><span id="t1-i3" class="value">—</span></div>
          </div>
        </div>
        <div class="kpi"><h3>Énergie (kWh)</h3><div id="t1-e" class="value">—</div></div>
      </div>
      <div class="card">
        <div class="card-head">
          <h3 class="text-lg font-semibold">Puissance active — TR1</h3>
          <label class="text-xs text-white/70 flex items-center gap-2">Base de temps
            <select id="win-p1" class="sel">
              <option value="15">15 min</option><option value="60">1 h</option>
              <option value="240">4 h</option><option value="1440">24 h</option>
              <option value="2880">48 h</option>
            </select>
          </label>
        </div>
        <canvas id="chartP1"></canvas>
      </div>
      <div class="card">
        <div class="card-head">
          <h3 class="text-lg font-semibold">Tensions de phase — TR1</h3>
          <label class="text-xs text-white/70 flex items-center gap-2">Base de temps
            <select id="win-u1" class="sel">
              <option value="15">15 min</option><option value="60">1 h</option>
              <option value="240">4 h</option><option value="1440">24 h</option>
              <option value="2880">48 h</option>
            </select>
          </label>
        </div>
        <canvas id="chartU1"></canvas>
      </div>
    </section>

    <!-- TR2 -->
    <section class="space-y-6">
      <h2 class="text-xl font-semibold">Transformateur 2</h2>
      <div class="grid-auto">
        <div class="kpi"><h3>Puissance (kW)</h3><div id="t2-p" class="value">—</div></div>
        <div class="kpi"><h3>Réactive (kvar)</h3><div id="t2-q" class="value">—</div></div>
        <div class="kpi"><h3>Facteur de Puissance</h3><div id="t2-pf" class="value">—</div></div>
        <div class="kpi">
          <h3>Tensions (V)</h3>
          <div class="group">
            <div class="sub"><span class="label">U12</span><span id="t2-u12" class="value">—</span></div>
            <div class="sub"><span class="label">U23</span><span id="t2-u23" class="value">—</span></div>
            <div class="sub"><span class="label">U31</span><span id="t2-u31" class="value">—</span></div>
          </div>
        </div>
        <div class="kpi">
          <h3>Courants (A)</h3>
          <div class="group">
            <div class="sub"><span class="label">I1</span><span id="t2-i1" class="value">—</span></div>
            <div class="sub"><span class="label">I2</span><span id="t2-i2" class="value">—</span></div>
            <div class="sub"><span class="label">I3</span><span id="t2-i3" class="value">—</span></div>
          </div>
        </div>
        <div class="kpi"><h3>Énergie (kWh)</h3><div id="t2-e" class="value">—</div></div>
      </div>
      <div class="card">
        <div class="card-head">
          <h3 class="text-lg font-semibold">Puissance active — TR2</h3>
          <label class="text-xs text-white/70 flex items-center gap-2">Base de temps
            <select id="win-p2" class="sel">
              <option value="15">15 min</option><option value="60">1 h</option>
              <option value="240">4 h</option><option value="1440">24 h</option>
              <option value="2880">48 h</option>
            </select>
          </label>
        </div>
        <canvas id="chartP2"></canvas>
      </div>
      <div class="card">
        <div class="card-head">
          <h3 class="text-lg font-semibold">Tensions de phase — TR2</h3>
          <label class="text-xs text-white/70 flex items-center gap-2">Base de temps
            <select id="win-u2" class="sel">
              <option value="15">15 min</option><option value="60">1 h</option>
              <option value="240">4 h</option><option value="1440">24 h</option>
              <option value="2880">48 h</option>
            </select>
          </label>
        </div>
        <canvas id="chartU2"></canvas>
      </div>
    </section>

    <footer class="pt-2 text-xs text-white/50">Dernière mise à jour : <span id="last-update">—</span></footer>
  </div>

<script>
  const $ = s => document.querySelector(s);
  function fmt(n, d = 1) { return (n == null || isNaN(n)) ? '—' : Number(n).toLocaleString('fr-FR', { minimumFractionDigits: d, maximumFractionDigits: d }); }

  // ---------- KPIs ----------
  function updateKPIs(patch) {
    const map = [
      ['t1_p_kw', 't1-p', 1], ['t1_q_kvar', 't1-q', 1], ['t1_pf', 't1-pf', 2],
      ['t1_u12_v', 't1-u12', 0], ['t1_u23_v', 't1-u23', 0], ['t1_u31_v', 't1-u31', 0],
      ['t1_i1_a', 't1-i1', 0], ['t1_i2_a', 't1-i2', 0], ['t1_i3_a', 't1-i3', 0], ['t1_e_kwh', 't1-e', 0],
      ['t2_p_kw', 't2-p', 1], ['t2_q_kvar', 't2-q', 1], ['t2_pf', 't2-pf', 2],
      ['t2_u12_v', 't2-u12', 0], ['t2_u23_v', 't2-u23', 0], ['t2_u31_v', 't2-u31', 0],
      ['t2_i1_a', 't2-i1', 0], ['t2_i2_a', 't2-i2', 0], ['t2_i3_a', 't2-i3', 0], ['t2_e_kwh', 't2-e', 0],
    ];
    for (const [key, id, dec] of map) {
      if (Object.prototype.hasOwnProperty.call(patch, key)) {
        const el = document.getElementById(id);
        if (el) el.textContent = fmt(patch[key], dec);
      }
    }
  }

  // --- util: dictionnaire en minuscules ---
function lowerKeys(obj) {
  const m = {};
  for (const k in obj) m[k.toLowerCase()] = obj[k];
  return m;
}

// Normalise les clés du snapshot de l'API → minuscules avec underscore (peu importe la casse côté API)
function normalizeSnapshot(d) {
  const m = lowerKeys(d);
  return {
    ts:     m.ts ?? m.ts_utc ?? null,

    p_kw:   m.p_kw   ?? m.p_kw ?? null,
    q_kvar: m.q_kvar ?? null,
    pf:     m.pf     ?? null,
    e_kwh:  m.e_kwh  ?? null,

    // tensions phase-phase
    u12_v:  m.u12_v ?? m.u1_v ?? null,
    u23_v:  m.u23_v ?? m.u2_v ?? null,
    u31_v:  m.u31_v ?? m.u3_v ?? null,

    // courants
    i1_a:   m.i1_a  ?? null,
    i2_a:   m.i2_a  ?? null,
    i3_a:   m.i3_a  ?? null,
  };
}
// -------- Historique /series au chargement --------
function normPoint(p) {
  // accepte {x: "...", y: ...} ou {X: "...", Y: ...}
  const x = p.x ?? p.X ?? null;
  const y = p.y ?? p.Y ?? null;
  return x ? { x: new Date(x).getTime(), y: Number(y) } : null;
}

function normalizeSeriesDto(dto) {
  // clés top-level en minuscules (p_kw, u12_v, etc.)
  const m = lowerKeys(dto);

  const pick = k => {
    const arr = m[k] ?? [];
    const out = [];
    for (const p of arr) {
      const np = normPoint(p);
      if (np) out.push(np);
    }
    return out;
  };

  return {
    p_kw:  pick('p_kw'),
    u12_v: pick('u12_v'),
    u23_v: pick('u23_v'),
    u31_v: pick('u31_v'),
    i1_a:  pick('i1_a'),
    i2_a:  pick('i2_a'),
    i3_a:  pick('i3_a'),
    e_kwh: pick('e_kwh'),
  };
}

// charge l'historique pour TR1/TR2 et remplit les buffers
async function loadSeries(trId) {
  // On prend la fenêtre de temps du sélecteur "puissance" du transfo concerné
  // (tu peux aussi prendre le max entre P et U si tu veux synchroniser les deux graphes)
  const key = trId === 1 ? 'p1' : 'p2';
  const winMin = Number(localStorage.getItem(`win_${key}`) || 15);

  // Construction de l'URL
  const url = new URL(`${state.apiBase}/tr${trId}/series`);
  url.searchParams.set('minutes', String(winMin));

  // Même granulométrie que le temps réel sur les petites fenêtres
  if (winMin <= 30) {
    url.searchParams.set('agg', 'second');     // moyenne/seconde
    url.searchParams.set('maxPoints', '10000'); // très dense
  } else {
    url.searchParams.set('agg', 'minute');     // moyenne/minute
    url.searchParams.set('maxPoints', '6000'); // dense mais raisonnable
  }

  // Pas de downsample côté API (on veut la même "texture" que le temps réel)
  url.searchParams.set('downsample', 'false');

  // Récupération + normalisation
  const raw = await fetchJSON(url.toString()).catch(e => { throw new Error(`series tr${trId}: ${e.message}`); });
  const s = normalizeSeriesDto(raw);

  // Push dans les bons buffers
  if (trId === 1) {
    bufs.p1     = s.p_kw;
    bufs.u1_12  = s.u12_v;
    bufs.u1_23  = s.u23_v;
    bufs.u1_31  = s.u31_v;
  } else {
    bufs.p2     = s.p_kw;
    bufs.u2_12  = s.u12_v;
    bufs.u2_23  = s.u23_v;
    bufs.u2_31  = s.u31_v;
  }

  // Dessine immédiatement l'historique
  refreshCharts();
}





  // ---------- État + settings ----------
  const state = {
    apiBase: localStorage.getItem('apiBase') || '',
    pollMs: Number(localStorage.getItem('pollMs') || 2000),
    initialLoad: true,
    win: { p1: Number(localStorage.getItem('win_p1') || 15),
           u1: Number(localStorage.getItem('win_u1') || 15),
           p2: Number(localStorage.getItem('win_p2') || 15),
           u2: Number(localStorage.getItem('win_u2') || 15) }
  };

  const dlg = $('#settings');
  $('#btn-settings').addEventListener('click', () => {
    $('#api-base').value = state.apiBase;
    $('#poll-ms').value = state.pollMs;
    dlg.showModal();
  });
  $('#save-settings').addEventListener('click', () => {
    state.apiBase = $('#api-base').value.trim();
    state.pollMs  = Number($('#poll-ms').value || 2000);
    localStorage.setItem('apiBase', state.apiBase);
    localStorage.setItem('pollMs', String(state.pollMs));
    dlg.close();
    stopPolling(); startPolling();
  });

  // ---------- Buffers + downsample ----------
  const MAX_MIN = 2880; // 48h
  const bufs = { p1: [], u1_12: [], u1_23: [], u1_31: [], p2: [], u2_12: [], u2_23: [], u2_31: [] };
  function cutoffTs(m) { return Date.now() - m * 60 * 1000; }
  function prune() { const c = cutoffTs(MAX_MIN); for (const k in bufs) while (bufs[k].length && bufs[k][0].x < c) bufs[k].shift(); }
  function push(b, x, y) { b.push({ x, y }); }
  function filt(arr, m) { const c = cutoffTs(m); let i = 0; while (i < arr.length && arr[i].x < c) i++; return arr.slice(i); }

  function downsample(data, threshold) {
    if (data.length <= threshold) return data;
    const sampled = [];
    const bucketSize = (data.length - 2) / (threshold - 2);
    let a = 0; sampled.push(data[a]);
    for (let i = 0; i < threshold - 2; i++) {
      const avgStart = Math.floor((i + 1) * bucketSize) + 1;
      const avgEnd   = Math.floor((i + 2) * bucketSize) + 1;
      const len = avgEnd - avgStart; if (len <= 0) continue;
      let ax = data[a].x, ay = data[a].y, avgx = 0, avgy = 0;
      for (let j = avgStart; j < avgEnd; j++) { avgx += data[j].x; avgy += data[j].y; }
      avgx /= len; avgy /= len;
      const rOff = Math.floor(i * bucketSize) + 1;
      const rTo  = Math.floor((i + 1) * bucketSize) + 1;
      let maxArea = -1, nextA = -1;
      for (let k = rOff; k < rTo; k++) {
        const area = Math.abs((ax - avgx) * (data[k].y - ay) - (ax - data[k].x) * (avgy - ay)) * 0.5;
        if (area > maxArea) { maxArea = area; nextA = k; }
      }
      sampled.push(data[nextA]); a = nextA;
    }
    sampled.push(data[data.length - 1]); return sampled;
  }

  const CHART_POINT_THRESHOLD = 10000;
  function refreshCharts() {
    const chartData = {
      p1: downsample(filt(bufs.p1, state.win.p1), CHART_POINT_THRESHOLD),
      u1_12: downsample(filt(bufs.u1_12, state.win.u1), CHART_POINT_THRESHOLD),
      u1_23: downsample(filt(bufs.u1_23, state.win.u1), CHART_POINT_THRESHOLD),
      u1_31: downsample(filt(bufs.u1_31, state.win.u1), CHART_POINT_THRESHOLD),
      p2: downsample(filt(bufs.p2, state.win.p2), CHART_POINT_THRESHOLD),
      u2_12: downsample(filt(bufs.u2_12, state.win.u2), CHART_POINT_THRESHOLD),
      u2_23: downsample(filt(bufs.u2_23, state.win.u2), CHART_POINT_THRESHOLD),
      u2_31: downsample(filt(bufs.u2_31, state.win.u2), CHART_POINT_THRESHOLD),
    };
    chartP1.data.datasets[0].data = chartData.p1;
    chartU1.data.datasets[0].data = chartData.u1_12;
    chartU1.data.datasets[1].data = chartData.u1_23;
    chartU1.data.datasets[2].data = chartData.u1_31;
    chartP2.data.datasets[0].data = chartData.p2;
    chartU2.data.datasets[0].data = chartData.u2_12;
    chartU2.data.datasets[1].data = chartData.u2_23;
    chartU2.data.datasets[2].data = chartData.u2_31;
    chartP1.update('none'); chartU1.update('none'); chartP2.update('none'); chartU2.update('none');
  }

  // ---------- FR time helpers ----------
  const displayFormats = {
    millisecond: 'HH:mm:ss', second: 'HH:mm:ss', minute: 'HH:mm',
    hour: 'HH:mm', day: 'dd/MM HH:mm', week: 'dd/MM HH:mm',
    month: 'dd/MM HH:mm', quarter: 'dd/MM HH:mm', year: 'dd/MM/yyyy'
  };
  function timeUnitFor(m) { return m <= 60 ? 'minute' : 'hour'; }
  function frTick(value) { return new Date(value).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}); }
  function frTooltip(context) {
    const t = context.raw?.x ?? context.parsed.x;
    return new Date(t).toLocaleString('fr-FR', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit'});
  }

  // ---------- Charts ----------
  function makeChart(ctx, label, yLabel, color, winMin) {
    return new Chart(ctx, {
      type: 'line',
      data: { datasets: [{ label, borderColor: color, data: [], pointRadius: 0, tension: 0 }] },
      options: {
        animation:false, responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: '#e5e7eb' } },
          tooltip: { callbacks: { title: items => items.map(frTooltip) } }
        },
        scales: {
          x: { type: 'time', time: { unit: timeUnitFor(winMin), displayFormats, tooltipFormat: 'HH:mm' },
               ticks: { color: '#ccc', callback: (v)=>frTick(v) } },
          y: { title: { display: true, text: yLabel }, ticks: { color: '#ccc' } }
        }
      }
    });
  }

  const chartP1 = makeChart($('#chartP1').getContext('2d'), 'P TR1 (kW)', 'kW', 'rgb(99,102,241)', 15);
  const chartU1 = new Chart($('#chartU1').getContext('2d'), {
    type: 'line',
    data: { datasets: [
      { label: 'U12', borderColor: 'rgb(16,185,129)', data: [], pointRadius: 0, tension: 0 },
      { label: 'U23', borderColor: 'rgb(59,130,246)', data: [], pointRadius: 0, tension: 0 },
      { label: 'U31', borderColor: 'rgb(234,179,8)', data: [], pointRadius: 0, tension: 0 }
    ] },
    options: {
      animation:false, responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#e5e7eb' } }, tooltip: { callbacks: { title: items => items.map(frTooltip) } } },
      scales: {
        x: { type: 'time', time: { unit: 'minute', displayFormats, tooltipFormat: 'HH:mm' }, ticks: { color: '#ccc', callback: (v)=>frTick(v) } },
        y: { title: { display: true, text: 'V' }, ticks: { color: '#ccc' } }
      }
    }
  });
  const chartP2 = makeChart($('#chartP2').getContext('2d'), 'P TR2 (kW)', 'kW', 'rgb(239,68,68)', 15);
  const chartU2 = new Chart($('#chartU2').getContext('2d'), {
    type: 'line',
    data: { datasets: [
      { label: 'U12', borderColor: 'rgb(168,85,247)', data: [], pointRadius: 0, tension: 0 },
      { label: 'U23', borderColor: 'rgb(14,165,233)', data: [], pointRadius: 0, tension: 0 },
      { label: 'U31', borderColor: 'rgb(245,158,11)', data: [], pointRadius: 0, tension: 0 }
    ] },
    options: {
      animation:false, responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#e5e7eb' } }, tooltip: { callbacks: { title: items => items.map(frTooltip) } } },
      scales: {
        x: { type: 'time', time: { unit: 'minute', displayFormats, tooltipFormat: 'HH:mm' }, ticks: { color: '#ccc', callback: (v)=>frTick(v) } },
        y: { title: { display: true, text: 'V' }, ticks: { color: '#ccc' } }
      }
    }
  });

  // Sélecteurs de fenêtre
  document.querySelectorAll('.sel').forEach(sel => {
    sel.addEventListener('change', () => {
      const key = sel.id.split('-')[1]; // p1/u1/p2/u2
      localStorage.setItem(`win_${key}`, sel.value);
      refreshCharts();
    });
  });

  // ---------- Connexion / Polling ----------
  function hideLoader() { if (state.initialLoad) { state.initialLoad = false; $('#loader').style.display = 'none'; } }
  function setConn(connected, message = '') {
    const led = $('#conn-led'), txt = $('#conn-text');
    led.style.color = connected ? '#10b981' : '#ef4444';
    txt.textContent = connected ? 'Connecté' : (message || 'Déconnecté');
    txt.title = connected ? '' : message;
  }
  async function fetchJSON(url, timeoutMs = 5000) {
    const ctrl = new AbortController(); const id = setTimeout(() => ctrl.abort(), timeoutMs);
    try { const r = await fetch(url, { signal: ctrl.signal }); if (!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json(); }
    finally { clearTimeout(id); }
  }

  let pollTimer = null;
  function stopPolling(){ if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }

  async function pollOnce() {
    if (!state.apiBase) { setConn(false, "API non configurée"); return; }
    try {
      const [raw1, raw2] = await Promise.all([
        fetchJSON(`${state.apiBase}/tr1/snapshot`).catch(e => { setConn(false, `TR1 API: ${e.message}`); return null; }),
        fetchJSON(`${state.apiBase}/tr2/snapshot`).catch(e => { setConn(false, `TR2 API: ${e.message}`); return null; })
      ]);
      const t = Date.now();
      const s1 = raw1 ? normalizeSnapshot(raw1) : null;
      const s2 = raw2 ? normalizeSnapshot(raw2) : null;
      if (s1) processData('tr1', s1, t);
      if (s2) processData('tr2', s2, t);
      if (s1 || s2) setConn(true);
      hideLoader();
    } catch (e) {
      setConn(false, "Erreur de l'API");
      hideLoader();
    }
  }

  function processData(tr, d, ts) {
    const t = ts || (d.ts ? new Date(d.ts).getTime() : Date.now());
    if (tr === 'tr1') {
      push(bufs.p1, t, d.p_kw ?? null);
      push(bufs.u1_12, t, d.u12_v ?? null);
      push(bufs.u1_23, t, d.u23_v ?? null);
      push(bufs.u1_31, t, d.u31_v ?? null);
      updateKPIs({ t1_p_kw: d.p_kw, t1_q_kvar: d.q_kvar, t1_pf: d.pf, t1_u12_v: d.u12_v, t1_u23_v: d.u23_v, t1_u31_v: d.u31_v, t1_i1_a: d.i1_a, t1_i2_a: d.i2_a, t1_i3_a: d.i3_a, t1_e_kwh: d.e_kwh });
    } else {
      push(bufs.p2, t, d.p_kw ?? null);
      push(bufs.u2_12, t, d.u12_v ?? null);
      push(bufs.u2_23, t, d.u23_v ?? null);
      push(bufs.u2_31, t, d.u31_v ?? null);
      updateKPIs({ t2_p_kw: d.p_kw, t2_q_kvar: d.q_kvar, t2_pf: d.pf, t2_u12_v: d.u12_v, t2_u23_v: d.u23_v, t2_u31_v: d.u31_v, t2_i1_a: d.i1_a, t2_i2_a: d.i2_a, t2_i3_a: d.i3_a, t2_e_kwh: d.e_kwh });
    }
    prune(); refreshCharts();
    $('#last-update').textContent = new Date().toLocaleString('fr-FR');
    hideLoader();
  }

  async function startPolling() {
  if (!state.apiBase) { setConn(false, "API non configurée"); return; }
  $('#loader').style.display = 'block'; state.initialLoad = true;
  stopPolling();

  try {
    // 1) Historique initial (TR1 + TR2)
    await Promise.all([ loadSeries(1), loadSeries(2) ]);
    refreshCharts(); // dessine tout de suite
    setConn(true);
  } catch (e) {
    console.error(e);
    setConn(false, "Chargement de l'historique impossible");
  } finally {
    $('#loader').style.display = 'none'; state.initialLoad = false;
  }

  // 2) Puis snapshots périodiques
  pollTimer = setInterval(pollOnce, state.pollMs);
  pollOnce();
}


  // ---------- Démarrage ----------
  startPolling();
</script>
</body>
</html>
