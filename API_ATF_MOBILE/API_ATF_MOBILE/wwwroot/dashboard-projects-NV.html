<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Projets 2025 ‚Äî Nathan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
          colors: {
            ink: { 900: "#0b0f14", 800: "#0f141b", 700: "#131924", 600: "#1a2332" },
            brand: { 400: "#34d399", 500: "#10b981", 600: "#059669" }
          },
          boxShadow: { glass: "0 10px 30px -12px rgba(0,0,0,.5)" }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="proxy-server.js"></script>
  <script src="assets/js/comments-component.js"></script>
    <style>
    html, body { background: #0b0f14; min-height: 100vh; }
    .card { backdrop-filter: blur(6px); background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border: 1px solid rgba(255,255,255,0.08); }
    .chip { border: 1px solid rgba(255,255,255,0.14); }
    .glow { box-shadow: 0 0 0 1px rgba(16,185,129,.18), 0 0 60px rgba(16,185,129,.08) inset; }
    .ribbon { position:absolute; top:10px; right:-36px; rotate:45deg; background: linear-gradient(90deg, rgba(234,179,8,.95), rgba(250,204,21,.85)); color:#111827; font-weight:700; font-size:10px; letter-spacing:.08em; padding:4px 40px; border:1px solid rgba(255,255,255,.25); text-transform:uppercase; box-shadow: 0 6px 18px rgba(0,0,0,.35); }
    
    /* Cacher la barre de d√©filement */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    @media print { .no-print { display:none !important; } .print-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } body { background: #fff; } }
  </style>
</head>
<body class="h-full text-slate-100 font-sans">
  <header class="no-print sticky top-0 z-50 border-b border-white/10 bg-ink-900/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
      <div class="h-8 w-8 rounded-xl bg-brand-500/20 grid place-items-center text-brand-400">‚öôÔ∏è</div>
      <div class="flex-1">
        <h1 class="text-lg sm:text-xl font-semibold tracking-tight">Dashboard Projets 2025 - VILLAUME Nathan</h1>
        <p class="text-xs text-slate-400">Synth√®se interactive ‚Äî ATS / ATR </p>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnPrint" class="px-3 py-2 text-sm rounded-lg bg-white/10 hover:bg-white/20 border border-white/10">Imprimer</button>
      </div>
    </div>
  </header>

  <section class="mx-auto max-w-7xl px-4 pt-6">
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      <div class="card rounded-2xl p-4 shadow-glass">
        <p class="text-slate-400 text-xs">Projets actifs</p>
        <p id="kpiProjects" class="text-2xl font-semibold">‚Äî</p>
      </div>
      <div class="card rounded-2xl p-4 shadow-glass">
        <p class="text-slate-400 text-xs">R√©sultats livr√©s</p>
        <p id="kpiResults" class="text-2xl font-semibold">‚Äî</p>
      </div>
      <div class="card rounded-2xl p-4 shadow-glass cursor-pointer hover:bg-white/5 transition-colors" id="kpiSkillsCard">
        <p class="text-slate-400 text-xs">Comp√©tences mises en jeu üîç</p>
        <p id="kpiSkills" class="text-2xl font-semibold">‚Äî</p>
      </div>
    </div>
  </section>

  <section class="no-print mx-auto max-w-7xl px-4 py-4">
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-xs text-slate-400">Filtres :</span>
      <button data-filter="all" class="chip rounded-full px-3 py-1 text-xs bg-white/10 hover:bg-white/20">Tout</button>
      <button data-filter="ATS" class="chip rounded-full px-3 py-1 text-xs bg-white/5 hover:bg-white/10">ATS</button>
      <button data-filter="ATR" class="chip rounded-full px-3 py-1 text-xs bg-white/5 hover:bg-white/10">ATR</button>
      <span class="mx-2 h-5 w-px bg-white/10"></span>
      <span class="text-xs text-slate-400">Statut :</span>
      <button data-status="all" class="chip rounded-full px-3 py-1 text-xs bg-white/10 hover:bg-white/20">Tous</button>
      <button data-status="en_cours" class="chip rounded-full px-3 py-1 text-xs bg-white/5 hover:bg-white/10">üü° En cours</button>
      <button data-status="livre" class="chip rounded-full px-3 py-1 text-xs bg-white/5 hover:bg-white/10">üü¢ Termin√©</button>
    </div>
  </section>

  <main class="mx-auto max-w-7xl px-4 pb-24">
    <div id="grid" class="grid print-grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </main>

  <div id="drawer" class="fixed inset-0 hidden z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" data-close></div>
    <aside class="relative w-full max-w-4xl max-h-[90vh] bg-ink-800 border border-white/10 card overflow-y-auto rounded-2xl shadow-2xl hide-scrollbar">
      <div class="p-5 flex items-center justify-between border-b border-white/10 sticky top-0 bg-ink-800/80 backdrop-blur z-10">
        <div>
          <h3 id="drawerTitle" class="text-lg font-semibold"></h3>
          <p id="drawerArea" class="text-xs text-slate-400"></p>
        </div>
        <button class="px-3 py-2 text-sm rounded-lg bg-white/10 hover:bg-white/20" data-close>Fermer</button>
      </div>
      <div class="p-5 space-y-6">
        <section>
          <h4 class="text-sm uppercase tracking-wide text-slate-400 mb-2">Objectif</h4>
          <p id="drawerObjective" class="text-slate-200"></p>
        </section>
        <section>
          <h4 class="text-sm uppercase tracking-wide text-slate-400 mb-2">R√©alisation</h4>
          <ul id="drawerReal" class="list-disc list-inside marker:text-brand-500 space-y-1"></ul>
        </section>
        <section>
          <h4 class="text-sm uppercase tracking-wide text-slate-400 mb-2">R√©sultats</h4>
          <ul id="drawerResults" class="list-disc list-inside marker:text-emerald-400 space-y-1"></ul>
        </section>
        <section id="drawerSkillsSection">
          <h4 id="drawerSkillsTitle" class="text-sm uppercase tracking-wide text-slate-400 mb-2">Comp√©tences</h4>
          <div id="drawerSkills" class="flex flex-wrap gap-2"></div>
        </section>
        <section id="drawerImagesSection">
          <h4 class="text-sm uppercase tracking-wide text-slate-400 mb-2">üì∏ Captures d'√©cran</h4>
          <div id="drawerImages" class="grid grid-cols-2 gap-3"></div>
        </section>
        <section id="drawerMediaSection">
          <h4 class="text-sm uppercase tracking-wide text-slate-400 mb-2">D√©mos & m√©dias</h4>
          <div id="drawerMedia" class="grid grid-cols-2 gap-3"></div>
        </section>
        <section class="mt-6 p-4 rounded-xl bg-slate-800/60 border border-slate-600/30">
          <div id="commentsContainer"></div>
        </section>
      </div>
    </aside>
  </div>

  <!-- Modal image agrandie -->
  <div id="imageModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/90" onclick="closeImageModal()">
    <button class="absolute top-4 right-4 text-white text-4xl hover:text-brand-400 transition-colors" onclick="closeImageModal()">&times;</button>
    <div class="relative max-w-7xl max-h-[90vh]">
      <img id="modalImage" src="" alt="" class="max-w-full max-h-[90vh] object-contain rounded-lg" onclick="event.stopPropagation()" />
      <p id="modalImageTitle" class="text-center text-white mt-4 text-lg"></p>
    </div>
  </div>

  <footer class="fixed bottom-3 right-3 text-[11px] text-slate-400/80 no-print">
    Derni√®re mise √† jour : <span id="lastUpdate"></span> ¬∑ Auteur : <span class="font-medium">N.Villaume</span>
  </footer>

  <script>
    // --- Donn√©es projets ---
    const DATA = [
      {
        id: "suivi-produit-ats",
        title: "Suivi Produit ‚Äì ATS",
        area: "ATS ¬∑ Supervision ¬∑ SQL",
        filters: ["ATS","Supervision","SQL"],
        status: "livre",
        objective: "Mettre en place une tra√ßabilit√© compl√®te des couronnes utilis√©es pour le treillis soud√©, du scan en entr√©e machine jusqu'au produit fini.",
        real_short: [
          "Scan √©tiquettes des couronnes d'√©bauche",
          "Impression √©tiquettes roquette",
          "Base SQL stock roquette"
        ],
        real: [
          "Scan des √©tiquettes des couronne d'√©bauche",
          "Impression d'√©tiquettes roquette (poids r√©el/th√©orique, lot, coul√©e‚Ä¶)",
          "Base SQL pour gestion de stock",
          "Int√©gration supervision/production"
        ],
        results_short: [
          "Tra√ßabilit√© compl√®te",
          "R√©duction erreurs",
          "Conformit√© renforc√©e"
        ],
        results: [
          "Tra√ßabilit√© compl√®te bout-en-bout du scan d'entr√©e au produit fini",
          "R√©duction significative des erreurs humaines de saisie",
          "Optimisation logistique et conformit√© aux exigences qualit√©"
        ],
        skills: ["SQL Server","Automatisme","RFID","Cimplicity","Basic Script","Gestion projet"],
        images: [
          { src: '/images/projets/suivi-produit-1.jpg?v=2', title: '√âtiquette roquette' },
          { src: '/images/projets/suivi-produit-2.jpg?v=3', title: 'Interface supervision' }
        ],
        media: []
      },
      {
        id: "gestion-rfid-ats",
        title: "Gestion RFID ‚Äì ATS",
        area: "ATS ¬∑ RFID ¬∑ S√©curit√©",
        filters: ["ATS","RFID","SQL","Supervision"],
        status: "livre",
        objective: "Chaque d√©marrage de machine est conditionn√© par la lecture du badge de pointage SAM, renfor√ßant ainsi la s√©curit√© et assurant une meilleure tra√ßabilit√©.",
        real_short: [
          "Badge obligatoire",
          "Base SQL √©quipes",
          "Stats op√©rateurs"
        ],
        real: [
          "RFID obligatoire au d√©marrage de chaque machine",
          "Badge chef requis en cas de casse-fil pour validation",
          "Base SQL de gestion d'√©quipes et personnels",
          "Statistiques compl√®tes par op√©rateur et machine"
        ],
        results_short: [
          "S√©curit√© renforc√©e",
          "Discipline accrue",
          "Tra√ßabilit√© op√©rateurs"
        ],
        results: [
          "S√©curit√© renforc√©e avec contr√¥le d'acc√®s syst√©matique",
          "Discipline accrue et responsabilisation des √©quipes",
          "Suivi pr√©cis de la productivit√© par op√©rateur et par poste"
        ],
        skills: ["C#","SQL Server","Cimplicity","Basic Script","RFID"],
        images: [
          { src: '/images/projets/Gestion_RFID_ATS-1.jpg?v=2', title: 'Interface RFID' },
          { src: '/images/projets/Gestion_RFID_ATS-2.jpg?v=2', title: 'Badge op√©rateur' }
        ],
        media: []
      },
      {
        id: "gestion-rfid-atr",
        title: "Gestion RFID ‚Äì ATR",
        area: "ATR ¬∑ RFID ¬∑ S√©curit√©",
        filters: ["ATR","RFID","SQL","Supervision"],
        status: "en_cours",
        objective: "D√©ployer le m√™me dispositif RFID sur l'unit√© ATR (projet en cours).",
        real_short: [
          "Controle d√©mmarage machines",
          "Adaptation base SQL existante",
          "Tracabilit√© Accrue"
        ],
        real: [
          "Analyse des points de badgeage sur l'unit√© ATR",
          "Int√©gration avec base SQL existante",
          "Adaptation vues supervision et droits d'acc√®s",
          "Tracabilit√© Accrue"
        ],
        results_short: [
          "POC en cours",
          "S√©curit√© cross-site",
          "Tra√ßabilit√© √©tendue"
        ],
        results: [
          "Projet en cours (POC + phase de cadrage)",
          "S√©curit√© renforc√©e sur les deux sites (ATS/ATR)",
          "Tra√ßabilit√© cross-site unifi√©e",
          "Harmonisation des processus entre ATS et ATR"
        ],
        skills: ["C#","SQL Server","Cimplicity","Basic Script","RFID","D√©ploiement multi-site"],
        images: [
          { src: '/images/projets/Gestion_RFID_ATR-1.jpg?v=1', title: 'Interface RFID ATR' }
        ],
        media: []
      },
      {
        id: "suivis-energies",
        title: "Suivis des Energies ‚Äì ATS / ATR",
        area: "ATS ¬∑ ATR ¬∑ Web ¬∑ DataViz",
        filters: ["ATS","ATR","SQL","Supervision"],
        status: "livre",
        objective: "Donner une vision temps r√©el des mesure √©nerg√©tiques pour optimiser les co√ªts et d√©tecter les anomalies facilement.",
        real_short: [
          "Pose compteurs √©nergie",
          "Collecte OPC ‚Üí SQL",
          "Supervision web"
        ],
        real: [
          "Pose de multiples compteurs d'√©nergie sur transformateurs et lignes",
          "Collecte automatique des donn√©es via OPC/IGS vers SQL Server",
          "Supervision ultra d√©taill√©e accessible depuis n'importe quel PC connect√© au r√©seau Sam/Riva, simplement via une URL",
          "Tableaux de bord interactifs avec graphiques temps r√©el"
        ],
        results_short: [
          "Vision temps r√©el",
          "D√©tection anomalies",
          "Optimisation co√ªts"
        ],
        results: [
          "Pilotage pr√©cis de l'√©nergie avec historiques d√©taill√©s",
          "D√©tection pr√©coce des d√©rives et anomalies de consommation",
          "Optimisation significative des co√ªts √©nerg√©tiques",
          "Support d√©cisionnel pour la direction avec KPIs √©nerg√©tiques"
        ],
        skills: ["OPC","S7","HTML5","Tailwind CSS","Chart.js","SQL Server","Communication industrielle"],
        images: [
          { src: '/images/projets/Suivis_des_Energies-1.jpg', title: 'Tableau de bord √©nerg√©tique' }
        ],
        media: [
          { type: "chart", label: "TR1 ‚Äî conso synth√®se" }
        ]
      },
      {
        id: "app-changement-gamme",
        title: "Application ¬´ Changement de Gamme ¬ª",
        area: "Android ¬∑ API ¬∑ UX",
        filters: ["Android","ATS"],
        status: "livre",
        objective: "Concevoir une application mobile destin√©e √† accompagner les √©quipes de production et de maintenance, afin d'optimiser leur efficacit√© et d'am√©liorer la coordination des changements de gammes.",
        real_short: [
          "Application Android",
          "API (Communication)",
          "Interface multi-devices"
        ],
        real: [
          "Programmation native ANDROID en langage Kotlin",
          "API   pour communication entre l'application et la base de donn√©es",
          "Navigation multi-√©crans adapt√©e (t√©l√©phone / tablette / PC)",
          "Interface Web d'administration pour gestion de l'utilisation de la tablette",
          "Syst√®me de notifications et guidage √©tape par √©tape"
        ],
        results_short: [
          "Gain de temps",
          "Organisation am√©lior√©e",
          "Tracabilit√© accrue"
        ],
        results: [
          "Gain de temps significatif pour les √©quipes, avec une baisse des erreurs de saisie",
          "Organisation et structure des √©tapes de changement de gamme simplifi√©e",
          "Acc√®s direct aux r√©sultats et rapports de suivi en temps r√©el"
        ],
        skills: ["Android","Kotlin","Retrofit","API REST","Architecture client/serveur","UI/UX"],
        images: [
          { src: '/images/projets/Appli_Chgt_Gamme_1.png?v=2', title: '√âcran d\'accueil' },
          { src: '/images/projets/Appli_Chgt_Gamme_2.png?v=2', title: 'Liste des Gammes' },
          { src: '/images/projets/Appli_Chgt_Gamme_3.png?v=2', title: 'Validation √©tapes' },
          { src: '/images/projets/Appli_Chgt_Gamme_4.png?v=2', title: 'Interface Parametres' }
        ],
        media: []
      },
      {
        id: "suivis-soudures-atr",
        title: "Suivis des Soudures - ATR",
        area: "ATR ¬∑ Supervision ¬∑ Qualit√©",
        filters: ["ATR","Supervision","SQL"],
        status: "livre",
        objective: "Mettre en place un suivi et une tra√ßabilit√© compl√®te des soudures.",
        real_short: [
          "Table √©change SAM/PLC",
          "Base SQL historique",
          "Affichage dynamique"
        ],
        real: [
          "Mise en place d'une table d'√©change standard entre le r√©seau SAM et les PLC des soudeuses",
          "Base SQL d√©di√©e pour historiser toutes les infos de soudure (date, ligne, lot, coul√©e, soudeur, param√®tres de soudage...)",
          "Affichage dynamique temps r√©el : liste des soudures + √©tat des soudeuses",
          "Saisie de commentaires en direct pour l'√©quipe de maintenance",
          "Export des donn√©es pour analyses qualit√©"
        ],
        results_short: [
          "Tra√ßabilit√© soudures",
          "Visibilit√© Etat soudeuses",
          "Analyses qualit√©"
        ],
        results: [
          "Tra√ßabilit√© compl√®te des soudures et recuits avec historique d√©taill√©",
          "Visibilit√© accrue sur l'√©tat des machines en temps r√©el",
          "Communication facilit√©e entre production et maintenance",
          "Exploitation des donn√©es pour analyses qualit√© et maintenance pr√©dictive",
          "Conformit√© aux exigences de tra√ßabilit√© industrielle"
        ],
        skills: ["Cimplicity","Basic Script","SQL Server","R√©seau industriel","Analyse de donn√©es"],
        images: [
          { src: '/images/projets/SuivisSoudure-1.jpg', title: 'Supervision soudures' },
          { src: '/images/projets/SuivisSoudure-2.jpg', title: 'Historique param√®tres' }
        ],
        media: []
      },
      {
        id: "camera-etiquette-atr",
        title: "D√©tection d'√©tiquette par Cam√©ra ‚Äì ATR",
        area: "ATR ¬∑ Vision ¬∑ Automatisme",
        filters: ["ATR","Vision","Automatisme"],
        status: "livre",
        objective: "Emp√™cher qu'une bobine sois stock√©e sans √©tiquette.",
        real_short: [
          "Cam√©ra IFM LIGNE 7",
          "D√©tection √©tiquette",
          "Int√©gration Profinet"
        ],
        real: [
          "Installation d'une cam√©ra IFM Vision Assistant sur le bobinoir de la ligne 7",
          "Param√©trage pr√©cis de l'algorithme de d√©tection d'√©tiquette (ROI, seuils, validation)",
          "Int√©gration compl√®te de la cam√©ra √† l'automate Siemens en Profinet",
          "Programmation du trigger pour piloter la cam√©ra au moment exact o√π l'√©tiquette est pos√©e",
          "Suivi statistique d√©taill√© des contr√¥les: nombre de d√©tections, taux de r√©ussite/√©chec, temps de cycle",
          "Interface op√©rateur pour visualisation en direct"
        ],
        results_short: [
          "Z√©ro d√©faut √©tiquette",
          "Contr√¥le automatique",
          "Fiabilit√© 100%"
        ],
        results: [
          "Suppression totale des risques d'exp√©dition de bobines sans √©tiquette",
          "Contr√¥le automatis√© ultra-rapide sans aucune surcharge pour l'op√©rateur",
          "Fiabilit√© renforc√©e du processus de production",
          "R√©duction drastique des non-conformit√©s client",
          "ROI rapide par √©limination des reprises et retours"
        ],
        skills: ["Vision industrielle","IFM Vision Assistant","Automatisme","Profinet","Statistiques"],
        images: [
          { src: '/images/projets/D√©tection_Etiquette-1.jpg', title: 'Cam√©ra de d√©tection' }
        ],
        media: []
      }
    ];

    // Fallback
    DATA.forEach(p => { if (!p.status) p.status = 'livre'; });

    // --- Variables globales ---
    const grid = document.getElementById('grid');
    const btnPrint = document.getElementById('btnPrint');
    const drawer = document.getElementById('drawer');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerArea = document.getElementById('drawerArea');
    const drawerObjective = document.getElementById('drawerObjective');
    const drawerReal = document.getElementById('drawerReal');
    const drawerResults = document.getElementById('drawerResults');
    const drawerSkills = document.getElementById('drawerSkills');
    const drawerMedia = document.getElementById('drawerMedia');
    const drawerMediaSection = document.getElementById('drawerMediaSection');
    const drawerImages = document.getElementById('drawerImages');
    const drawerImagesSection = document.getElementById('drawerImagesSection');
    const drawerSkillsSection = document.getElementById('drawerSkillsSection');
    const drawerSkillsTitle = document.getElementById('drawerSkillsTitle');
    let currentProjectId = null;

    let activeFilter = 'all';
    let activeStatus = 'all';

    // --- Composant de commentaires V2 ---
    let commentsComponent = null;

    // --- Fonctions utilitaires ---
    function chip(txt) {
      return `<span class="chip text-[11px] px-2 py-1 rounded-full bg-white/5">${txt}</span>`;
    }

    function uniq(arr) { 
      return [...new Set(arr)]; 
    }

    // --- Gestion du drawer ---
    function openDrawer(p) {
      currentProjectId = p.id;
      
      drawerTitle.textContent = p.title;
      drawerArea.textContent = p.area;
      drawerObjective.textContent = p.objective;
      drawerReal.innerHTML = p.real.map(x=>`<li>${x}</li>`).join('');
      drawerResults.innerHTML = p.results.map(x=>`<li>${x}</li>`).join('');
      
      // R√©initialiser la section des comp√©tences pour un projet normal
      drawerSkillsSection.classList.remove('hidden');
      drawerSkillsTitle.textContent = 'Comp√©tences';
      drawerSkills.innerHTML = p.skills.map(chip).join('');

      // Charger les commentaires avec le nouveau composant V2
      if (commentsComponent) {
        commentsComponent.setEntity(p.id);
      }

      // Afficher les images
      if (!p.images || p.images.length === 0) {
        drawerImagesSection.classList.add('hidden');
      } else {
        drawerImagesSection.classList.remove('hidden');
        drawerImages.innerHTML = p.images.map((img, i) => {
          const safeTitle = (img.title || '').replace(/'/g, "\\'");
          return `
          <div class="relative group cursor-pointer" onclick="openImageModal('${img.src}', '${safeTitle}')">
            <img src="${img.src}" alt="${img.title || 'Capture ' + (i+1)}" 
                 class="w-full h-48 object-cover rounded-xl border border-white/10 transition-transform hover:scale-105" />
            ${img.title ? `<p class="text-xs text-slate-400 mt-1">${img.title}</p>` : ''}
          </div>
        `}).join('');
      }

      if (!p.media || p.media.length === 0) {
        drawerMediaSection.classList.add('hidden');
      } else {
        drawerMediaSection.classList.remove('hidden');
        drawerMedia.innerHTML = p.media.map((m,i)=>{
          if (m.type === 'chart') return `<canvas data-chart-id="${p.id}-media-${i}" height="140" class="rounded-xl bg-ink-700 p-2 border border-white/10"></canvas>`;
          return '';
        }).join('');

        p.media?.forEach((m,i)=>{
          if (m.type === 'chart') {
            setTimeout(() => {
              const canvas = document.querySelector(`canvas[data-chart-id="${p.id}-media-${i}"]`);
              if (canvas) {
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: Array.from({length: 12}, (_,k)=>`${k}:00`),
                    datasets: [{
                      label: m.label || 'S√©rie',
                      data: Array.from({length: 12}, ()=>Math.round(Math.random()*100)),
                      fill: false,
                      borderColor: '#10b981',
                      backgroundColor: '#10b981'
                    }]
                  },
                  options: { responsive: true, maintainAspectRatio: false }
                });
              }
            }, 100);
          }
        });
      }

      drawer.classList.remove('hidden');
    }

    function closeDrawer() { 
      drawer.classList.add('hidden'); 
    }

    // --- Gestion du modal image ---
    function openImageModal(src, title) {
      const modal = document.getElementById('imageModal');
      const img = document.getElementById('modalImage');
      const titleEl = document.getElementById('modalImageTitle');
      img.src = src;
      titleEl.textContent = title || '';
      modal.classList.remove('hidden');
    }

    function closeImageModal() {
      document.getElementById('imageModal').classList.add('hidden');
    }

    // --- Rendu des cartes ---
    function renderCards(list) {
      grid.innerHTML = '';
      list.forEach(p => {
        const el = document.createElement('article');
        el.className = 'card relative rounded-2xl p-4 shadow-glass hover:shadow-2xl hover:shadow-black/30 transition-shadow duration-300';

        const isEnCours = (p.status||'livre') === 'en_cours';
        const statusEmoji = isEnCours ? 'üü°' : 'üü¢';
        const statusLabel = isEnCours ? 'En cours' : 'Termin√©';

        el.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="h-10 w-10 rounded-xl bg-brand-500/15 text-brand-400 grid place-items-center">üìå</div>
            <div class="flex-1">
              <div class="flex items-center justify-between gap-3">
                <h3 class="text-base font-semibold leading-tight flex items-center gap-2">
                  ${p.title}
                  <span class="chip text-[10px] px-2 py-0.5 rounded-full bg-white/5">${statusEmoji} ${statusLabel}</span>
                </h3>
                <button class="text-xs px-2 py-1 rounded-lg bg-white/10 hover:bg-white/20" data-open>Voir</button>
              </div>
              <p class="text-xs text-slate-400 mt-0.5">${p.area}</p>
              <div class="mt-4 mb-3 p-3 rounded-lg bg-gradient-to-r from-brand-500/10 to-brand-600/5 border-l-2 border-brand-500">
                <p class="text-xs uppercase tracking-wide text-brand-400 font-semibold mb-1">üéØ Objectif</p>
                <p class="text-sm text-slate-100 leading-relaxed">${p.objective}</p>
              </div>
              <div class="flex flex-wrap gap-1 mt-3">${p.skills.slice(0,5).map(chip).join('')}</div>
              <div class="mt-4 grid grid-cols-2 gap-2">
                <div class="rounded-xl bg-ink-700/60 border border-white/10 p-3">
                  <p class="text-[10px] text-slate-400">R√©alisation</p>
                  <ul class="mt-1 text-sm list-disc list-inside marker:text-brand-500 space-y-1">
                    ${(p.real_short || p.real.slice(0,3)).map(x=>`<li>${x}</li>`).join('')}
                  </ul>
                </div>
                <div class="rounded-xl bg-ink-700/60 border border-white/10 p-3">
                  <p class="text-[10px] text-slate-400">R√©sultats</p>
                  <ul class="mt-1 text-sm list-disc list-inside marker:text-emerald-400 space-y-1">
                    ${(p.results_short || p.results.slice(0,3)).map(x=>`<li>${x}</li>`).join('')}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;

        el.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', ()=> openDrawer(p)) );
        grid.appendChild(el);
      });
    }

    // --- Filtrage ---
    function renderFiltered(){
      let list = DATA;
      if (activeFilter !== 'all') list = list.filter(p=>p.filters.includes(activeFilter));
      if (activeStatus !== 'all') list = list.filter(p=>(p.status||'livre')===activeStatus);
      renderCards(list);
      updateKPIs(list);
    }

    // --- KPIs ---
    function updateKPIs(list){
      const projects = list.length;
      const results = list.reduce((a,p)=> a + (p.results?.length||0), 0);
      const skills = uniq(list.flatMap(p=>p.skills)).length;
      document.getElementById('kpiProjects').textContent = projects;
      document.getElementById('kpiResults').textContent = results;
      document.getElementById('kpiSkills').textContent = skills;
    }

    // --- Lexique des comp√©tences ---
    const skillsLexicon = {
      "SQL Server": "Syst√®me de gestion de base de donn√©es relationnelle Microsoft pour stocker, g√©rer et exploiter les donn√©es de production.",
      "Automatisme": "Programmation et configuration d'automates industriels (PLC) pour piloter les machines et processus de production.",
      "RFID": "Technologie de Radio-Identification pour l'identification automatique et la tra√ßabilit√© par badges sans contact.",
      "Cimplicity": "Logiciel de supervision industrielle GE Digital pour la visualisation et le contr√¥le des processus en temps r√©el.",
      "Basic Script": "Langage de script int√©gr√© √† Cimplicity pour automatiser les t√¢ches et cr√©er des logiques personnalis√©es.",
      "Gestion projet": "Coordination, planification et suivi de projets industriels du cadrage √† la livraison.",
      "C#": "Langage de programmation orient√© objet Microsoft pour d√©velopper des applications desktop Windows.",
      "OPC": "Standard de communication industrielle (OPC DA/UA) pour √©changer des donn√©es entre automates et logiciels.",
      "S7": "Gamme d'automates programmables Siemens (S7-300, S7-1200, S7-1500) et langage de programmation associ√©.",
      "HTML5": "Langage de balisage web moderne pour cr√©er des interfaces utilisateur interactives et responsives.",
      "Tailwind CSS": "Framework CSS utilitaire pour concevoir rapidement des interfaces web modernes et √©l√©gantes.",
      "Chart.js": "Biblioth√®que JavaScript open-source pour cr√©er des graphiques et visualisations de donn√©es interactifs.",
      "Communication industrielle": "Mise en place et exploitation de r√©seaux industriels (Profinet, Ethernet/IP, Modbus...).",
      "Android": "D√©veloppement d'applications mobiles natives pour la plateforme Android.",
      "Kotlin": "Langage de programmation moderne et officiel pour le d√©veloppement d'applications Android.",
      "Retrofit": "Biblioth√®que Android pour g√©rer les communications HTTP avec des API REST de mani√®re simplifi√©e.",
      "API REST": "Conception et utilisation d'interfaces de programmation web pour l'√©change de donn√©es entre syst√®mes.",
      "Architecture client/serveur": "Conception d'applications distribu√©es avec s√©paration des responsabilit√©s entre client et serveur.",
      "UI/UX": "Design d'interfaces utilisateur intuitives et conception d'exp√©riences utilisateur optimales.",
      "R√©seau industriel": "Configuration et exploitation de r√©seaux d√©di√©s √† l'automatisme (Profinet, Ethernet industriel).",
      "Analyse de donn√©es": "Exploitation et interpr√©tation de donn√©es industrielles pour optimiser les processus.",
      "Vision industrielle": "Syst√®mes de contr√¥le qualit√© par cam√©ra pour la d√©tection et l'inspection automatis√©e.",
      "IFM Vision Assistant": "Logiciel et syst√®me de vision industrielle IFM pour le param√©trage de cam√©ras intelligentes.",
      "Profinet": "Protocole de communication industriel Siemens bas√© sur Ethernet pour l'automatisation temps r√©el.",
      "Statistiques": "Collecte, analyse et exploitation de donn√©es chiffr√©es pour le pilotage et l'am√©lioration continue.",
      "D√©ploiement multi-site": "D√©ploiement et harmonisation de solutions techniques sur plusieurs sites de production.",
      "Impression √©tiquettes": "Gestion et automatisation de l'impression d'√©tiquettes de tra√ßabilit√©.",
      "C# Desktop": "D√©veloppement d'applications Windows desktop avec l'environnement .NET et C#."
    };

    // --- Affichage de toutes les comp√©tences ---
    function showAllSkills() {
      const allSkills = uniq(DATA.flatMap(p=>p.skills)).sort();
      
      drawerTitle.textContent = 'üìö Lexique des Comp√©tences';
      drawerArea.textContent = `${allSkills.length} comp√©tences techniques mobilis√©es`;
      
      // Cr√©er les bulles cliquables DANS l'objectif (en haut)
      const chipsHTML = allSkills.map(skill => {
        const safeId = skill.replace(/[^a-zA-Z0-9]/g, '_');
        return `<span class="chip text-xs px-3 py-1 rounded-full bg-white/10 hover:bg-brand-500/30 cursor-pointer transition-colors" onclick="scrollToSkill('${safeId}')">${skill}</span>`;
      }).join('');
      
      drawerObjective.innerHTML = `
        <p class="text-slate-200 mb-4">Ensemble des savoir-faire techniques mis en ≈ìuvre dans les projets 2025.</p>
        <div class="mt-4 p-3 rounded-lg bg-slate-800/60 border border-slate-600/30">
          <p class="text-xs uppercase tracking-wide text-slate-400 mb-3">üîç Cliquez sur une comp√©tence pour voir sa d√©finition</p>
          <div class="flex flex-wrap gap-2">${chipsHTML}</div>
        </div>
      `;
      
      // Cr√©er le lexique avec IDs dans REALISATION
      const lexiqueHTML = allSkills.map(skill => {
        const description = skillsLexicon[skill] || 'Comp√©tence technique sp√©cialis√©e.';
        const safeId = skill.replace(/[^a-zA-Z0-9]/g, '_');
        return `
          <div id="skill-${safeId}" class="skill-card mb-4 p-4 rounded-xl bg-ink-700/60 border border-white/10 hover:border-brand-500/30 transition-all">
            <h4 class="text-base font-semibold text-brand-400 mb-2 flex items-center gap-2">
              <span class="text-brand-500">‚ñ∏</span> ${skill}
            </h4>
            <p class="text-sm text-slate-300 leading-relaxed">${description}</p>
          </div>
        `;
      }).join('');
      
      drawerReal.innerHTML = lexiqueHTML;
      drawerResults.innerHTML = '';
      drawerSkillsSection.classList.add('hidden');
      drawerMediaSection.classList.add('hidden');
      drawerImagesSection.classList.add('hidden');
      
      drawer.classList.remove('hidden');
    }
    
    // Fonction pour scroller vers une comp√©tence et la mettre en surbrillance
    function scrollToSkill(skillId) {
      const element = document.getElementById('skill-' + skillId);
      if (element) {
        // Enlever le highlight de tous les √©l√©ments
        document.querySelectorAll('.skill-card').forEach(card => {
          card.classList.remove('bg-brand-500/20', 'border-brand-500', 'scale-105');
        });
        
        // Scroller vers l'√©l√©ment
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Ajouter le highlight
        element.classList.add('bg-brand-500/20', 'border-brand-500', 'scale-105');
        
        // Retirer le highlight apr√®s 2 secondes
        setTimeout(() => {
          element.classList.remove('bg-brand-500/20', 'border-brand-500', 'scale-105');
        }, 2000);
      }
    }

    // --- Initialisation ---
    document.addEventListener('DOMContentLoaded', async function() {
      // Initialiser le composant de commentaires V2
      commentsComponent = new CommentsComponent('commentsContainer', {
        apiBaseUrl: '/api/commentsv2',
        currentUser: window.__SESSION_USER || null,
        limit: 50
      });
      
      // Rendu initial
      renderCards(DATA);
      updateKPIs(DATA);
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('fr-FR');

      // Event listeners pour les filtres
      const filterButtons = document.querySelectorAll('[data-filter]');
      const statusButtons = document.querySelectorAll('[data-status]');

      filterButtons.forEach(btn => btn.addEventListener('click', () => {
        activeFilter = btn.dataset.filter;
        filterButtons.forEach(b=> b.classList.remove('bg-white/20'));
        btn.classList.add('bg-white/20');
        renderFiltered();
      }));

      statusButtons.forEach(btn => btn.addEventListener('click', () => {
        activeStatus = btn.dataset.status;
        statusButtons.forEach(b=> b.classList.remove('bg-white/20'));
        btn.classList.add('bg-white/20');
        renderFiltered();
      }));

      // Event listeners pour le drawer
      drawer.addEventListener('click', (e)=>{ if (e.target.dataset.close !== undefined) closeDrawer(); });
      window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeDrawer(); });

      // Event listener pour le KPI comp√©tences
      document.getElementById('kpiSkillsCard').addEventListener('click', showAllSkills);

      // Event listeners pour les boutons
      btnPrint.addEventListener('click', () => window.print());

      console.info('‚úÖ Dashboard initialis√© avec', DATA.length, 'projets');
      console.info('‚úÖ Syst√®me de commentaires V2 initialis√© (JSONL multi-utilisateurs)');
    });
    </script>
</body>
</html>
