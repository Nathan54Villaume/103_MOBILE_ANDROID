<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Menu Settings Final - Tous ProblÃ¨mes CorrigÃ©s</title>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: system-ui; 
            padding: 20px; 
            margin: 0;
        }
        .test-area {
            width: 500px;
            height: 300px;
            background: #1e293b;
            border: 2px solid #4b5563;
            margin: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }
        .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #4f46e5;
        }
        .btn-success {
            background: #059669;
        }
        .btn-success:hover {
            background: #047857;
        }
        .btn-warning {
            background: #f59e0b;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        #info {
            background: #111827;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .test-section h3 {
            margin-top: 0;
            color: #f1f5f9;
        }
        .test-checklist {
            background: #0f172a;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .test-checklist li {
            margin: 5px 0;
            padding: 2px 0;
        }
        .test-checklist .check {
            color: #10b981;
        }
        .test-checklist .cross {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Menu Settings Final - Tous ProblÃ¨mes CorrigÃ©s</h1>
    <p>Test complet des corrections apportÃ©es au menu de rÃ©glages</p>
    
    <div class="test-grid">
        <div class="test-section">
            <h3>ğŸ“Š Chart de Test</h3>
            <div class="test-area" id="testArea">
                <div style="text-align: center;">
                    <div>ğŸ“ˆ Chart de Test</div>
                    <div style="font-size: 14px; margin-top: 10px; color: #94a3b8;">
                        Clic droit pour menu contextuel<br>
                        Ou bouton "Ouvrir Settings"
                    </div>
                </div>
            </div>
            <button onclick="testSettingsMenu()" class="btn">
                ğŸ”§ Ouvrir Settings
            </button>
            <button onclick="testChartCreation()" class="btn btn-success">
                ğŸ“Š CrÃ©er Chart
            </button>
        </div>
        
        <div class="test-section">
            <h3>âœ… Checklist des Corrections</h3>
            <div class="test-checklist">
                <h4>ProblÃ¨mes corrigÃ©s :</h4>
                <ul>
                    <li class="check">âœ… Bouton "Fermer" fonctionne</li>
                    <li class="check">âœ… Bouton "Valider" sauvegarde et ferme</li>
                    <li class="check">âœ… Ã‰paisseur des lignes persiste</li>
                    <li class="check">âœ… Alignement bouton paramÃ¨tres avancÃ©s</li>
                    <li class="check">âœ… Ã‰tat actuel du chart chargÃ©</li>
                    <li class="check">âœ… ParamÃ¨tres reflÃ¨tent la rÃ©alitÃ©</li>
                </ul>
                
                <h4>Tests Ã  effectuer :</h4>
                <ul>
                    <li>ğŸ”§ Ouvrir le menu de rÃ©glages</li>
                    <li>ğŸ“ Changer l'Ã©paisseur de ligne</li>
                    <li>ğŸ‘ï¸ Tester le bouton paramÃ¨tres avancÃ©s</li>
                    <li>ğŸ’¾ Cliquer sur "Valider"</li>
                    <li>ğŸ”„ Rouvrir le menu (doit garder les paramÃ¨tres)</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>ğŸ›ï¸ Tests SpÃ©cifiques</h3>
        <button onclick="testCloseButton()" class="btn btn-warning">Test Bouton Fermer</button>
        <button onclick="testSaveButton()" class="btn btn-warning">Test Bouton Valider</button>
        <button onclick="testLineWidthPersistence()" class="btn btn-warning">Test Persistance Ã‰paisseur</button>
        <button onclick="testAdvancedToggle()" class="btn btn-warning">Test Toggle AvancÃ©</button>
        <button onclick="testStateLoading()" class="btn btn-warning">Test Chargement Ã‰tat</button>
        <button onclick="clearLog()" class="btn">ğŸ—‘ï¸ Vider Logs</button>
    </div>
    
    <div id="info"></div>
    
    <!-- Inclure les dÃ©pendances nÃ©cessaires -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <script type="module">
        // Import des modules
        import { initChart, getChart } from './charts/index.js';
        import { initChartSettings } from './js/chart-settings.js';
        
        const info = document.getElementById('info');
        let testChartInstance = null;
        
        function log(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            info.appendChild(div);
            info.scrollTop = info.scrollHeight;
        }
        
        function clearLog() {
            info.innerHTML = '';
        }
        
        // Initialiser le systÃ¨me de settings
        initChartSettings();
        log('âœ… SystÃ¨me de settings initialisÃ©');
        
        // CrÃ©er un canvas de test
        function createTestCanvas() {
            const canvas = document.createElement('canvas');
            canvas.id = 'test-chart-canvas';
            canvas.width = 480;
            canvas.height = 280;
            canvas.style.border = '1px solid #4b5563';
            canvas.style.borderRadius = '8px';
            canvas.style.background = '#0f172a';
            return canvas;
        }
        
        // CrÃ©er des donnÃ©es de test rÃ©alistes
        function generateTestData() {
            const now = Date.now();
            const data1 = [];
            const data2 = [];
            
            for (let i = 0; i < 50; i++) {
                const time = now - (49 - i) * 60000; // 1 point par minute
                const value1 = 100 + Math.sin(i * 0.2) * 30 + Math.random() * 10;
                const value2 = 80 + Math.cos(i * 0.15) * 25 + Math.random() * 8;
                
                data1.push({ x: time, y: value1 });
                data2.push({ x: time, y: value2 });
            }
            
            return {
                datasets: [
                    {
                        label: 'Signal TR1 Puissance',
                        data: data1,
                        borderColor: '#6366f1',
                        backgroundColor: '#6366f120',
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: 'Signal TR2 Puissance',
                        data: data2,
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b20',
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            };
        }
        
        // CrÃ©er un chart de test
        window.testChartCreation = async function() {
            try {
                log('ğŸ“Š CrÃ©ation d\'un chart de test...');
                
                // CrÃ©er le canvas
                const canvas = createTestCanvas();
                document.getElementById('testArea').innerHTML = '';
                document.getElementById('testArea').appendChild(canvas);
                
                // Initialiser le chart
                testChartInstance = initChart('test-chart', 'test-chart-canvas', {
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#e2e8f0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    tooltipFormat: 'HH:mm:ss'
                                },
                                ticks: {
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(148,163,184,0.15)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(148,163,184,0.15)'
                                }
                            }
                        }
                    }
                });
                
                if (testChartInstance) {
                    log('âœ… Chart de test crÃ©Ã© avec succÃ¨s');
                    
                    // Ajouter des donnÃ©es de test
                    const testData = generateTestData();
                    testChartInstance.host.setData(testData.datasets);
                    log('ğŸ“ˆ DonnÃ©es de test ajoutÃ©es (2 signaux, 50 points chacun)');
                    
                } else {
                    log('âŒ Ã‰chec de crÃ©ation du chart');
                }
                
            } catch (error) {
                log(`âŒ Erreur crÃ©ation chart: ${error.message}`);
                console.error('Erreur dÃ©taillÃ©e:', error);
            }
        };
        
        // Tester le menu de settings
        window.testSettingsMenu = function() {
            if (!testChartInstance) {
                log('âš ï¸ CrÃ©er d\'abord un chart de test');
                return;
            }
            
            try {
                log('ğŸ”§ Ouverture du menu de settings...');
                
                // Simuler l'Ã©vÃ©nement d'ouverture des settings
                const event = new CustomEvent('chart:open-settings', {
                    detail: { chartKey: 'test-chart' }
                });
                document.dispatchEvent(event);
                
                log('âœ… Ã‰vÃ©nement chart:open-settings envoyÃ©');
                
            } catch (error) {
                log(`âŒ Erreur ouverture settings: ${error.message}`);
                console.error('Erreur dÃ©taillÃ©e:', error);
            }
        };
        
        // Tests spÃ©cifiques
        window.testCloseButton = function() {
            log('ğŸ§ª Test du bouton fermer...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Cliquer sur "Fermer" (en haut Ã  droite)');
            log('   3. Le menu doit se fermer sans sauvegarder');
        };
        
        window.testSaveButton = function() {
            log('ğŸ§ª Test du bouton valider...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Modifier des paramÃ¨tres (ex: Ã©paisseur ligne)');
            log('   3. Cliquer sur "Valider" (en bas Ã  droite)');
            log('   4. Le menu doit se fermer ET sauvegarder les paramÃ¨tres');
        };
        
        window.testLineWidthPersistence = function() {
            log('ğŸ§ª Test de persistance Ã©paisseur ligne...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Changer l\'Ã©paisseur de ligne (ex: 4px)');
            log('   3. Cliquer sur "Valider"');
            log('   4. Rouvrir le menu - l\'Ã©paisseur doit Ãªtre Ã  4px');
        };
        
        window.testAdvancedToggle = function() {
            log('ğŸ§ª Test du toggle paramÃ¨tres avancÃ©s...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Cliquer sur "ParamÃ¨tres avancÃ©s"');
            log('   3. La flÃ¨che doit tourner et la section s\'afficher');
            log('   4. Le texte doit Ãªtre alignÃ© avec la flÃ¨che');
        };
        
        window.testStateLoading = function() {
            log('ğŸ§ª Test de chargement de l\'Ã©tat actuel...');
            log('   1. CrÃ©er un chart avec des paramÃ¨tres spÃ©cifiques');
            log('   2. Ouvrir le menu de settings');
            log('   3. Les paramÃ¨tres doivent reflÃ©ter l\'Ã©tat actuel du chart');
        };
        
        // Test du menu contextuel
        document.getElementById('testArea').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            log('ğŸ–±ï¸ Clic droit dÃ©tectÃ© - test du menu contextuel');
            
            // Simuler l'ouverture du menu contextuel
            const event = new CustomEvent('chart:contextmenu', {
                detail: { 
                    chartKey: 'test-chart',
                    x: e.clientX,
                    y: e.clientY
                }
            });
            document.dispatchEvent(event);
        });
        
        // Ã‰couter les Ã©vÃ©nements de settings
        document.addEventListener('chart:open-settings', function(e) {
            log(`ğŸ“¢ Ã‰vÃ©nement chart:open-settings reÃ§u pour: ${e.detail?.chartKey}`);
        });
        
        document.addEventListener('chart:export', function(e) {
            log(`ğŸ“¢ Ã‰vÃ©nement chart:export reÃ§u pour: ${e.detail?.chartKey}`);
        });
        
        document.addEventListener('chart:reset-view', function(e) {
            log(`ğŸ“¢ Ã‰vÃ©nement chart:reset-view reÃ§u pour: ${e.detail?.chartKey}`);
        });
        
        log('ğŸš€ SystÃ¨me de test initialisÃ©');
        log('ğŸ‘‰ Instructions:');
        log('   1. Cliquer sur "CrÃ©er Chart" pour crÃ©er un graphique de test');
        log('   2. Cliquer sur "Ouvrir Settings" pour tester le menu');
        log('   3. Utiliser les boutons de test spÃ©cifiques');
        log('   4. VÃ©rifier que tous les problÃ¨mes sont corrigÃ©s');
    </script>
</body>
</html>
