<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Menu Settings Final - Tous Problèmes Corrigés</title>
    <style>
        body { 
            background: #0f172a; 
            color: white; 
            font-family: system-ui; 
            padding: 20px; 
            margin: 0;
        }
        .test-area {
            width: 500px;
            height: 300px;
            background: #1e293b;
            border: 2px solid #4b5563;
            margin: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
        }
        .btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        .btn:hover {
            background: #4f46e5;
        }
        .btn-success {
            background: #059669;
        }
        .btn-success:hover {
            background: #047857;
        }
        .btn-warning {
            background: #f59e0b;
        }
        .btn-warning:hover {
            background: #d97706;
        }
        #info {
            background: #111827;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #1e293b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #334155;
        }
        .test-section h3 {
            margin-top: 0;
            color: #f1f5f9;
        }
        .test-checklist {
            background: #0f172a;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        .test-checklist li {
            margin: 5px 0;
            padding: 2px 0;
        }
        .test-checklist .check {
            color: #10b981;
        }
        .test-checklist .cross {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Menu Settings Final - Tous Problèmes Corrigés</h1>
    <p>Test complet des corrections apportées au menu de réglages</p>
    
    <div class="test-grid">
        <div class="test-section">
            <h3>📊 Chart de Test</h3>
            <div class="test-area" id="testArea">
                <div style="text-align: center;">
                    <div>📈 Chart de Test</div>
                    <div style="font-size: 14px; margin-top: 10px; color: #94a3b8;">
                        Clic droit pour menu contextuel<br>
                        Ou bouton "Ouvrir Settings"
                    </div>
                </div>
            </div>
            <button onclick="testSettingsMenu()" class="btn">
                🔧 Ouvrir Settings
            </button>
            <button onclick="testChartCreation()" class="btn btn-success">
                📊 Créer Chart
            </button>
        </div>
        
        <div class="test-section">
            <h3>✅ Checklist des Corrections</h3>
            <div class="test-checklist">
                <h4>Problèmes corrigés :</h4>
                <ul>
                    <li class="check">✅ Bouton "Fermer" fonctionne</li>
                    <li class="check">✅ Bouton "Valider" sauvegarde et ferme</li>
                    <li class="check">✅ Épaisseur des lignes persiste</li>
                    <li class="check">✅ Alignement bouton paramètres avancés</li>
                    <li class="check">✅ État actuel du chart chargé</li>
                    <li class="check">✅ Paramètres reflètent la réalité</li>
                </ul>
                
                <h4>Tests à effectuer :</h4>
                <ul>
                    <li>🔧 Ouvrir le menu de réglages</li>
                    <li>📏 Changer l'épaisseur de ligne</li>
                    <li>👁️ Tester le bouton paramètres avancés</li>
                    <li>💾 Cliquer sur "Valider"</li>
                    <li>🔄 Rouvrir le menu (doit garder les paramètres)</li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>🎛️ Tests Spécifiques</h3>
        <button onclick="testCloseButton()" class="btn btn-warning">Test Bouton Fermer</button>
        <button onclick="testSaveButton()" class="btn btn-warning">Test Bouton Valider</button>
        <button onclick="testLineWidthPersistence()" class="btn btn-warning">Test Persistance Épaisseur</button>
        <button onclick="testAdvancedToggle()" class="btn btn-warning">Test Toggle Avancé</button>
        <button onclick="testStateLoading()" class="btn btn-warning">Test Chargement État</button>
        <button onclick="clearLog()" class="btn">🗑️ Vider Logs</button>
    </div>
    
    <div id="info"></div>
    
    <!-- Inclure les dépendances nécessaires -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    
    <script type="module">
        // Import des modules
        import { initChart, getChart } from './charts/index.js';
        import { initChartSettings } from './js/chart-settings.js';
        
        const info = document.getElementById('info');
        let testChartInstance = null;
        
        function log(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            info.appendChild(div);
            info.scrollTop = info.scrollHeight;
        }
        
        function clearLog() {
            info.innerHTML = '';
        }
        
        // Initialiser le système de settings
        initChartSettings();
        log('✅ Système de settings initialisé');
        
        // Créer un canvas de test
        function createTestCanvas() {
            const canvas = document.createElement('canvas');
            canvas.id = 'test-chart-canvas';
            canvas.width = 480;
            canvas.height = 280;
            canvas.style.border = '1px solid #4b5563';
            canvas.style.borderRadius = '8px';
            canvas.style.background = '#0f172a';
            return canvas;
        }
        
        // Créer des données de test réalistes
        function generateTestData() {
            const now = Date.now();
            const data1 = [];
            const data2 = [];
            
            for (let i = 0; i < 50; i++) {
                const time = now - (49 - i) * 60000; // 1 point par minute
                const value1 = 100 + Math.sin(i * 0.2) * 30 + Math.random() * 10;
                const value2 = 80 + Math.cos(i * 0.15) * 25 + Math.random() * 8;
                
                data1.push({ x: time, y: value1 });
                data2.push({ x: time, y: value2 });
            }
            
            return {
                datasets: [
                    {
                        label: 'Signal TR1 Puissance',
                        data: data1,
                        borderColor: '#6366f1',
                        backgroundColor: '#6366f120',
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: 'Signal TR2 Puissance',
                        data: data2,
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b20',
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            };
        }
        
        // Créer un chart de test
        window.testChartCreation = async function() {
            try {
                log('📊 Création d\'un chart de test...');
                
                // Créer le canvas
                const canvas = createTestCanvas();
                document.getElementById('testArea').innerHTML = '';
                document.getElementById('testArea').appendChild(canvas);
                
                // Initialiser le chart
                testChartInstance = initChart('test-chart', 'test-chart-canvas', {
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#e2e8f0'
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    tooltipFormat: 'HH:mm:ss'
                                },
                                ticks: {
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(148,163,184,0.15)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(148,163,184,0.15)'
                                }
                            }
                        }
                    }
                });
                
                if (testChartInstance) {
                    log('✅ Chart de test créé avec succès');
                    
                    // Ajouter des données de test
                    const testData = generateTestData();
                    testChartInstance.host.setData(testData.datasets);
                    log('📈 Données de test ajoutées (2 signaux, 50 points chacun)');
                    
                } else {
                    log('❌ Échec de création du chart');
                }
                
            } catch (error) {
                log(`❌ Erreur création chart: ${error.message}`);
                console.error('Erreur détaillée:', error);
            }
        };
        
        // Tester le menu de settings
        window.testSettingsMenu = function() {
            if (!testChartInstance) {
                log('⚠️ Créer d\'abord un chart de test');
                return;
            }
            
            try {
                log('🔧 Ouverture du menu de settings...');
                
                // Simuler l'événement d'ouverture des settings
                const event = new CustomEvent('chart:open-settings', {
                    detail: { chartKey: 'test-chart' }
                });
                document.dispatchEvent(event);
                
                log('✅ Événement chart:open-settings envoyé');
                
            } catch (error) {
                log(`❌ Erreur ouverture settings: ${error.message}`);
                console.error('Erreur détaillée:', error);
            }
        };
        
        // Tests spécifiques
        window.testCloseButton = function() {
            log('🧪 Test du bouton fermer...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Cliquer sur "Fermer" (en haut à droite)');
            log('   3. Le menu doit se fermer sans sauvegarder');
        };
        
        window.testSaveButton = function() {
            log('🧪 Test du bouton valider...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Modifier des paramètres (ex: épaisseur ligne)');
            log('   3. Cliquer sur "Valider" (en bas à droite)');
            log('   4. Le menu doit se fermer ET sauvegarder les paramètres');
        };
        
        window.testLineWidthPersistence = function() {
            log('🧪 Test de persistance épaisseur ligne...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Changer l\'épaisseur de ligne (ex: 4px)');
            log('   3. Cliquer sur "Valider"');
            log('   4. Rouvrir le menu - l\'épaisseur doit être à 4px');
        };
        
        window.testAdvancedToggle = function() {
            log('🧪 Test du toggle paramètres avancés...');
            log('   1. Ouvrir le menu de settings');
            log('   2. Cliquer sur "Paramètres avancés"');
            log('   3. La flèche doit tourner et la section s\'afficher');
            log('   4. Le texte doit être aligné avec la flèche');
        };
        
        window.testStateLoading = function() {
            log('🧪 Test de chargement de l\'état actuel...');
            log('   1. Créer un chart avec des paramètres spécifiques');
            log('   2. Ouvrir le menu de settings');
            log('   3. Les paramètres doivent refléter l\'état actuel du chart');
        };
        
        // Test du menu contextuel
        document.getElementById('testArea').addEventListener('contextmenu', function(e) {
            e.preventDefault();
            log('🖱️ Clic droit détecté - test du menu contextuel');
            
            // Simuler l'ouverture du menu contextuel
            const event = new CustomEvent('chart:contextmenu', {
                detail: { 
                    chartKey: 'test-chart',
                    x: e.clientX,
                    y: e.clientY
                }
            });
            document.dispatchEvent(event);
        });
        
        // Écouter les événements de settings
        document.addEventListener('chart:open-settings', function(e) {
            log(`📢 Événement chart:open-settings reçu pour: ${e.detail?.chartKey}`);
        });
        
        document.addEventListener('chart:export', function(e) {
            log(`📢 Événement chart:export reçu pour: ${e.detail?.chartKey}`);
        });
        
        document.addEventListener('chart:reset-view', function(e) {
            log(`📢 Événement chart:reset-view reçu pour: ${e.detail?.chartKey}`);
        });
        
        log('🚀 Système de test initialisé');
        log('👉 Instructions:');
        log('   1. Cliquer sur "Créer Chart" pour créer un graphique de test');
        log('   2. Cliquer sur "Ouvrir Settings" pour tester le menu');
        log('   3. Utiliser les boutons de test spécifiques');
        log('   4. Vérifier que tous les problèmes sont corrigés');
    </script>
</body>
</html>
